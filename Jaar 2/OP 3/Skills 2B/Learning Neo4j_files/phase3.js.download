var ep = window.ep || {}; ep.bundles = ep.bundles || []; ep.bundles = ep.bundles.concat('bundled/page/ebook/phase3.js','ep/viewer/ebook/viewer.js', 'ep/viewer/ebook/datamanager.js', 'ep/viewer/ebook/toc.js', 'ep/viewer/ebook/tools.js', 'ep/viewer/ebook/bookinfo.js', 'ep/viewer/ebook/renew.js', 'ep/viewer/ebook/accessibility.js', 'ep/viewer/ebook/viewer-phased.js', 'ep/widgets/eppanel.js', 'ep/widgets/pagingwidget.js', 'ep/widgets/epeditor.js', 'ep/controller/control/columnresize.js', 'jquery/plugins/jquery.ba-resize.js', 'ep/viewer/ebook/viewer_resize.js', 'ep/viewer/ebook/checkin.js', 'ep/viewer/ebook/ifrmpgwatcher.js', 'ep/viewer/ebook/epubifrmscripts.js', 'rangy-1.2.3/rangy-core.js', 'rangy-1.2.3/rangy-position.js');
ep.register("ep.ebookViewer",(function(a){var d={};var b={};var m={STEP:25,PPI:110,RPS_UNITS:1200,WIDTH:"width",PAGE:"page",IN:"in",OUT:"out",SCROLLBAR:20,FIT_MARGIN:0.05};var l=false;var c=m.WIDTH;function g(r){d=r;h();a(document).bind("docReady.ebookViewer",function(w,x,v){if(""===x.artifactId){var t=false;for(var u=0;!t&&u<v.pageData.length;u++){t=(v.pageData[u].id===x.ppId);if(t){x.artifactId=v.pageData[u].artifactId;}}}b=x;e(v);});a(document).bind("toolsPageTurn.ebookViewer",function(u,v,t){if(t){ep.debug("Viewer:toolsPageTurn.ebookViewer got artifactId = "+t);b=d.getPageByArtifactId(t);}else{ep.debug("Viewer:toolsPageTurn.ebookViewer got theNewPageIndex = "+v);b=d.getPageByIndex(v);}j(t);});ep.subscribe("pageTurn.ebookViewer",function(t){b=d.getPageByIndex(t.thePage.index);});function s(t){b=t;j();}ep.subscribe("ebook-toc-click",s);ep.subscribe("ebook-searchwithin-click",s);ep.subscribe("ebook-note-page-click",s);ep.subscribe("toolsZoom.ebookViewer",function(t){if(d.getPageMode()!=="EPUB"&&!l){k(t);}});ep.subscribe("getDocument.epubViewer",function(t){b=d.getPageByArtifactId(t.theArtifactId);j(t.theArtifactId);});a(document).bind("pageError.ebookViewer",function(u,v,t){if(v&&v!==""){window.location=v;}else{if(t&&t!==""){window.location=ep.utilities.replaceEPCommand("detail")+"&"+t;}else{window.location=ep.utilities.replaceEPCommand("detail");}}});ep.subscribe("pageViewed.ebookViewer",function(v){var u=v.pageIndex;var t=v.format;var w=ep.utilities.buildAjaxRequestPath("ebookViewer/pageturnandrenewal",ep.clientData.currentRecord);w+="&theRetrievalFormat="+t;w+="&thePageNum="+u;w+="&thePageLabel="+v.pageLabel;a.ajax({cache:false,url:w,success:function(x){a.noop();},error:function(x,y){ep.debug("pageturnandrenewal(): failed!");}});});a(document).bind("documentScroll.epubViewer",function(t,u){ep.debug("User scrolled, current page is "+JSON.stringify(b));ep.debug("			   they are now at ppid = "+u.ppid);ep.debug("			   they are now at lpid = "+u.logicalPart);if(u.ppid!==b.ppid){b=d.getPageByPpId(u.ppid,u.logicalPart);a(document).trigger("pageTurn",[b,null]);}});var q=".toc-section",o=false,p=false;a("input[name='content-group']").on("change",function(){var t=a(this).val();a(this).parent().siblings("li").removeClass("selected").attr("aria-selected","false");a(this).parent().addClass("selected").attr("aria-selected","true");if(o){o=false;a(".viewer-section").toggleClass("open");}switch(t){case"content":a(q).hide();q=".toc-section";a(q).show();break;case"search-within":a(q).hide();q=".search-within-section";a(q).show();a("#LeftPanelContent").on("searchwithin.created",function(){a("#LeftPanelContent").trigger("panelReady",["searchwithin",q]);});ep.require("ep/viewer/ebook/searchwithin.js");break;case"my-notes":a(q).hide();q=".my-notes-section";a(q).show();if(!p){a("#LeftPanelContent").on("notespanel.created",function(){a("#LeftPanelContent").trigger("panelReady",["addnote",true]);p=true;});ep.require("ep/viewer/ebook/notespanel.js");}a(window).trigger("resizePanel","notePanel");break;}});function n(){var v=a(".viewer-delivery"),u=a(".evt-more"),t=u.hasClass("active");if(v.hasClass("no-wrap")){u.addClass("active").attr("aria-expanded","true");}else{u.removeClass("active").attr("aria-expanded","false");}v.children().each(function(){if(t){a(this).find("a").attr("tabindex","-1");}else{a(this).find("a").attr("tabindex","0");}});}a(".evt-more").on("click",function(t){n();a(window).trigger("showMoreTools");});a(".evt-more").bind("keydown",function(t){var u=t.which===13,v=t.which===32;if(u||v){n();a(window).trigger("showMoreTools");setTimeout(function(){a(".evt-more").focus();},0);}});a(".evt-close-panel").on("click",function(t){a(".viewer-section").toggleClass("open");a("input[name='content-group']").removeAttr("checked");o=true;t.preventDefault();});a("#pull-tools").on("click",function(t){a("#ViewerWrap").toggleClass("show-tools-overlay");a(this).toggleClass("show-this");a("#viewport").toggleClass("hidden");t.preventDefault();});a(".close-tools").on("click",function(t){a("#ViewerWrap").removeClass("show-tools-overlay");a("#pull-tools").removeClass("show-this");a("#viewport").removeClass("hidden");t.preventDefault();});a(".close-panel").on("click",function(t){a("#ViewerWrap").removeClass("show-contents-overlay");a("#ViewerWrap").removeClass("show-tools-overlay");a("#pull-tools").removeClass("show-this");a("#viewport").removeClass("hidden");t.preventDefault();});a("#pull-contents").on("click",function(t){a("#ViewerWrap").addClass("show-contents-overlay");ep.publish("ebookViewer.resizeOverlays");a("#viewport").addClass("hidden");t.preventDefault();});a(".close-contents").on("click",function(t){a("#ViewerWrap").removeClass("show-contents-overlay");a("#viewport").removeClass("hidden");t.preventDefault();});a(".search-within-section").on("click",".list-item-snippet",function(t){a("#ViewerWrap").removeClass("show-contents-overlay");a("#viewport").removeClass("hidden");t.preventDefault();});a(".toc-section").on("click",".treelist-record>a",function(t){a("#ViewerWrap").removeClass("show-contents-overlay");a("#viewport").removeClass("hidden");t.preventDefault();});a(".my-notes-section").on("click","a[data-ppid]",function(t){a("#ViewerWrap").removeClass("show-contents-overlay");a("#viewport").removeClass("hidden");t.preventDefault();});a(".viewer-tool .icon").on("click",function(t){if(!a(this).hasClass("active")){a(".viewer-tool .icon").removeClass("active");a(this).addClass("active");}t.preventDefault();});a(".fit-page .icon, .fit-width .icon").on("click",function(t){a("#viewport").scrollLeft(0);a("#viewport").css({"overflow-x":"hidden"});t.preventDefault();});a(".plus .icon, .minus .icon").on("click",function(t){a("#viewport").css({"overflow-x":"auto"});t.preventDefault();});a(document).on("keydown",function(t){if(t.keyCode===27){a(".close-panel").trigger("click");t.preventDefault();}});a("#contents-tab, #search-tab, #notes-tab").on("keydown",function(t){if(t.keyCode===13){a(this).find("input").trigger("click");}});i();}function h(){ep.require("ep/util/disablecontextmenu.js");ep.getInstance({epId:"ep.controller.CollapsibleController",page:"ebookviewer"});}function i(n,p,o){ep.publish("getDocument.ebookViewer",{theDoid:n,theIndex:p,theLpId:o});}function e(n){c=b.zoom=m.WIDTH;ep.publish("documentLoaded.ebookViewer",{theDoc:n,thePage:b},true);a("#TOCItems ul :first span a").attr("accesskey","9");}function j(n){ep.debug("Viewer:_pageTurn("+n+")");b.zoom=c;a(document).trigger("pageTurn",[b,n||""]);ep.publish("pageTurn.ebookViewer",{thePage:b,theArtifactId:n});}function k(p){ep.debug("viewer->_pageZoom() <<");if(p===m.WIDTH||p===m.PAGE){c=p;j();return;}var n=f();if(c===m.WIDTH){c=n.width;}else{if(c===m.PAGE){c=n.page;}}var o=Math.floor(c+(m.STEP*(p===m.IN?1:-1)));if(o>0){c=o;}if(Math.abs((c-n.width)/n.width)<m.FIT_MARGIN){c=m.WIDTH;}else{if(Math.abs((c-n.page)/n.page)<m.FIT_MARGIN){c=m.PAGE;}}j();ep.debug("viewer->_pageZoom() >>");}function f(v){var p=v?v:b.index;var t=a(".viewport").width()-20;var s=a(".viewport").height();var q=d.getPageDimensions(p).width/m.RPS_UNITS;var o=d.getPageDimensions(p).height/m.RPS_UNITS;var u=t/(q*m.PPI);var n=s/(o*m.PPI);var r=u>n;return{width:Math.round(u*100),page:Math.round((r?n:u)*100)};}a(document).bind("dataManagerReady.ebookViewer",function(n){g(ep.ebookViewer.dataManager);});return{currentPage:function(){return b;},setCurrentZoom:function(n){c=n;},getZoomConstants:function(){return m;},pageTurn:function(n){j(n);},setPDFJSEnabled:function(n){l=n;},getEffectiveZoom:function(n){return f(n);}};})(jQuery));ep.register("ep.ebookViewer.dataManager",(function(a){var d={};var c=[];var b={};var g=null;var h=null;var t=null;var w=null;var x={};function u(){if(ep.clientData){b=ep.clientData.ebookViewer;if("sessionStorage" in window&&window.sessionStorage!==null){sessionStorage.setItem("ek",b.Bsk);}}ep.subscribe("getDocument.ebookViewer",function(B){z(B.theDoid,B.theIndex,B.theLpId);i();});ep.subscribe("ep.ebookViewer.dataManager:ready",function(){a(document).trigger("dataManagerReady.ebookViewer");},true);}function z(B,C,D){if(!B){g=b.Doid;h=b.Format;t=b.PageIndex;w=b.Lpid;}else{g=B;h=b.Format;t=C;w=D;}}function i(){var B={url:ep.utilities.buildAjaxRequestPath("ebookViewer/DigitalObject",ep.clientData.currentRecord),data:"theFormat="+h};if(x!==null&&x.url===B.url&&x.data===B.data){return;}x=B;a(document).trigger("getDocumentStarted.dataManager",true);a.ajax({url:B.url,data:B.data,success:function(C){e(C);a(document).trigger("getDocumentCompleted.dataManager",true);},error:function(){a(document).trigger("getDocumentCompleted.dataManager",false);}});}function e(B){d=B;if(A()){if(d.ek&&d.sei){a("body").append("<div id='ek' data-k='"+d.ek+"' data-si='"+d.sei+"'></div>");}v(d.contents,true);f();}else{d=null;}}function A(){return(d&&d.id===g);}function f(){var B=(t!==null&&t!==undefined&&t!==-1)?k(t):l(w);a(document).trigger("docReady.ebookViewer",[B,d]);ep.publish("docReady.ebookViewer",[B,d]);}function v(E,F){var D;var B=[];if(F){c=[];}for(D in E){if(E.hasOwnProperty(D)){var C=E[D];if(!c[C.id]){c[C.id]=C;}B=B.concat(C.pages);if(!ep.utilities.isEmptyObj(C.childContents)){C.childPages=y(C.pages.concat(v(C.childContents,false)));B=B.concat(C.childPages);}else{C.childPages=C.pages;}}}return B;}function y(F){var C={},D=[],B;for(var E=0;E<F.length;E++){C[F[E]]=0;}for(B in C){if(C.hasOwnProperty(B)){D.push([B]);}}return D;}function l(B){return{index:c[B].pid,artifactId:c[B].artifactId,title:c[B]?c[B].title:"<No Title>",ppId:d.pageData[c[B].pid].id,lpId:B,label:d.pageData[c[B].pid].label,mode:o(c[B].artifactId)};}function k(F,E){var C,D="";if(undefined===E){for(C in c){if(c.hasOwnProperty(C)){var B=c[C];if(a.inArray(F,B.pages)>-1){D=B.id;break;}}}}else{D=E;}return{index:F,artifactId:d.pageData[F].artifactId,title:c[D]?c[D].title:"<No Title>",ppId:d.pageData[F].id,lpId:D,label:d.pageData[F].label,mode:o(d.pageData[F].artifactId)};}function j(E){var D=E;var F=E.indexOf("#");var C=0;var B;var H;if(F>0){D=E.substr(0,F);}if("EK"===b.Format){for(var G=0;G<d.fileData.length;G++){B=d.fileData[G];H=(B.artifactId.indexOf(D)>=0);if(H){C=G;break;}}return m(d.fileData[C].ppids[0]);}else{for(C in c){if(c.hasOwnProperty(C)){B=c[C];H=(B.artifactId.indexOf(D)>=0);if(H){theLpId=C;break;}}}return{index:c[theLpId].pid,artifactId:c[theLpId].artifactId,title:c[theLpId].title,ppId:d.pageData[c[theLpId].pid].id,lpId:theLpId,label:d.pageData[c[theLpId].pid].label,mode:o(c[theLpId].artifactId)};}}function m(F,E){var D,B="";for(D in d.pageData){if(d.pageData.hasOwnProperty(D)){var C=d.pageData[D];if(F===C.id){B=D;break;}}}return k(parseInt(B,10),E);}function s(C){var B=c[C].childPages;return r(B);}function r(E){var D=[];var C="";for(C in E){if(E.hasOwnProperty(C)){var B=E[C];D.push(d.pageData[B].id);}}return D;}function o(B){return B.startsWith("previewlimit")?"HTML":d.sourceFormat;}function n(E){var D=-1;var C=0;var B=false;while(!B&&C<d.pageData.length){if(!d.pageData[C].isPageContinuation){D++;B=(d.pageData[C].id===E);C++;}else{while(!B&&C<d.pageData.length&&d.pageData[C].isPageContinuation){B=(d.pageData[C].id===E);C++;}}}return D;}function q(E){var C=-1;var D=[];for(var B=0;B<d.pageData.length;B++){if(d.pageData[B]!==null&&!d.pageData[B].isPageContinuation){C++;if(E.indexOf(C)>-1){D.push(d.pageData[B].id);if(D.length===E.length){break;}}}}return D;}function p(E){var C=[];for(var D=0;D<E.length;D++){var B=n(E[D]);if(C.indexOf(B)===-1){C.push(B);}}return q(C);}a(u);return{currentDoc:function(){return{id:d.id,format:b.Format,an:d.an,db:d.db,tag:d.tag,title:d.title,pageCount:d.pageData.length,isCopyRestricted:!d.isCopyFullTextAllowed};},getPageByIndex:function(B){return k(B);},getPageByLpId:function(B){return l(B);},getPageByArtifactId:function(B){return j(B);},getPageByPpId:function(C,B){return m(C,B);},getPpIdsByLpId:function(B){return s(B);},getPpIdsByIndex:function(B){return r(B);},getPageDimensions:function(B){return{height:d.pageData[B].height,width:d.pageData[B].width};},getPageMode:function(){return o(d.pageData[0].artifactId);},getPageIndexFromPpid:function(B){return n(B);},getPageStartPpidsFromPageIndices:function(B){return q(B);},getPageStartPpids:function(B){return p(B);}};})(jQuery));(function(a,j){var g={};function f(t,s,u){var q=a("<div>");var p;for(p in s){if(s.hasOwnProperty(p)){var o=s[p];var k=!ep.utilities.isEmptyObj(o.childContents);var n=k&&u<3;var l={className:k?(n?"icon expanded":"icon collapsed"):"icon",title:k?(n?ep.messages.Hide_Level:ep.messages.Show_Level):""};var m=n?"true":"false";var r=q.text(o.title).html();t.append('<li data-auto="toc_treelist_item" role="treeitem" aria-expanded="'+m+'"><span data-auto="toc_treelist_item_record" class="treelist-record"><span data-auto="toc_treelist_item_selected" class="'+l.className+'"'+(k?(' tabindex="0" title="'+l.title+'" >'+l.title):"> ")+'</span><a data-auto="toc_treelist_item_link" tabindex="0" href="#" title="'+r+'">'+r+"</a></span></li>");t.find("a").last().attr("data-lpid",o.id);if(k){t.children("li").last().append('<ul data-auto="toc_treelist" class="treelist-list"'+(n?"":'style="display:none"')+' role="group"></ul>');f(t.children("li").last().children("ul").first(),o.childContents,u+1);}}}}function i(k){g.find(".selected").removeClass("selected");g.find("a[data-lpid="+k+"]").parent().addClass("selected");ep.publish("eBookViewer.updateTitle",g.find("a[data-lpid="+k+"]").parent("span").find("a").text());}function b(l){var k=a(l.target);if(k.is(".icon.collapsed, .icon.expanded")){h(k);}}function d(k){if(k.which===13){b(k);}}function h(l){l.toggleClass("collapsed expanded");l.text(l.hasClass("expanded")?ep.messages.Hide_Level:ep.messages.Show_Level);l.attr("title",l.hasClass("expanded")?ep.messages.Hide_Level:ep.messages.Show_Level);l.parent().parent().attr("aria-expanded",l.hasClass("expanded")?"true":"false");l.parent().siblings("ul").toggle();var k=g.children("#TOCItems");if("true"===k.children().first().attr("aria-expanded")){k.css("overflow","auto");}else{k.css("overflow","hidden");}}function e(l){var k=g.children("#TOCItems");k.detach();k.empty();f(k,l,2);g.append(k);}function c(){g=a("#TOC");ep.subscribe("documentLoaded.ebookViewer",function(k){var l=k.theDoc;var m=k.thePage;e(l.contents);i(m.lpId);},true);ep.subscribe("pageTurn.ebookViewer",function(k){var l=k.thePage;i(l.lpId);});a(document).bind("documentScroll.epubViewer",function(k,l){i(l.logicalPart);});g.bind("click",function(k){b(k);});g.bind("keypress",function(k){d(k);});g.delegate("[data-lpid]","click",function(k){ep.publish("ebook-toc-click",ep.ebookViewer.dataManager.getPageByLpId(a(k.currentTarget).data().lpid));});}a(c);})(jQuery,window);ep.require("jquery/plugins/jquery.ba-throttle-debounce.js",function(){ep.register("ep.ebookViewer.toolsInterface",(function(a){var C={};var t=[];var s={};var u=null;var f=null;var c="";var e=[];var A="";var H=false;function j(){C=a(".viewer-tools, .single-page-navigation");s=a("#pageLabel")[0];if(!s){s=a("<div/>");s.attr("id","pageLabel").attr("value","nada");}C.on("click",a.debounce(250,function(J){b(J);}));a(document).keydown(function(J){m(J);});ep.subscribe("documentLoaded.ebookViewer",function(J){var K=J.theDoc;var L=J.thePage;t=K.pageData;v(L.index);A=(ep.ebookViewer.dataManager.currentDoc().format==="EB")?"PDF":"EPUB";if("EPUB"===A){e=K.fileData;k();}else{l();}F(L.zoom);},true);ep.subscribe("pageTurn.ebookViewer",function(J){var K=J.thePage;if(K.index!==c){v(K.index);}F(K.zoom);});setTimeout(function(){ep.publish("ep.ebookViewer.toolsInterface.ready");},0);}function l(){u=a("#pageSlider").slider({range:"max",value:c,min:0,max:t.length-1});u.on("slide",a.debounce(200,function(J,K){z(J,K);}));}function k(){f=a("#pageSlider").slider({range:"max",value:t[c].fileIndex,min:0,max:e.length-1});f.on("slide",a.debounce(250,function(J,K){y(J,K);}));}function z(J,K){v(K.value);r();}function y(J,K){v(ep.ebookViewer.dataManager.getPageByPpId(e[K.value].ppids[0]).index);r();}function b(L){var J=a(L.target);var K=J.parent();if((J.hasClass("next-page")||J.hasClass("nextPage"))&&!J.prop("disabled")){p();}else{if((J.hasClass("prev-page")||J.hasClass("previousPage"))&&!J.prop("disabled")){w();}else{if(J.hasClass("firstPage")){g();}else{if(J.hasClass("lastPage")){if("EPUB"===A){n();}else{o();}}else{if(J.hasClass("go")){i(s.value);}else{if(K.hasClass("plus")){I("in");}else{if(K.hasClass("minus")){I("out");}else{if(K.hasClass("fit-width")){I("width");}else{if(K.hasClass("fit-page")){I("page");}else{if(K.hasClass("restore")){B();}}}}}}}}}}}function m(J){if(J.target&&J.target.tagName==="INPUT"){if((J.target.id===s.id)&&(J.which===13)){i(J.target.value);}else{return;}}else{if(J.which===39){p();}else{if(J.which===37){w();}else{if(J.which===122){B();}else{if(J.which===27){if(a("body").hasClass("full-screen")){d(true);}}}}}}}function i(L){var J=-1,K=0;for(;K<t.length;K++){if(t[K].label===L){J=K;break;}}if(J>=0){v(J);r();}else{E();}}function h(J){if(c!==J){v(J);r();}}function q(J){var K=0;if("EPUB"===A){K=ep.ebookViewer.dataManager.getPageByPpId(e[t[c].fileIndex+1].ppids[0]).index;}else{K=J+1;}return K;}function p(){var J=q(c);if(G(J)){v(J);r();ep.publish("arrow-click-pageturn");}}function x(J){var K=0;if("EPUB"===A){K=ep.ebookViewer.dataManager.getPageByPpId(e[t[c].fileIndex-1].ppids[0]).index;}else{K=J-1;}return K;}function w(){var J=x(c);if(G(J)){v(J);r();ep.publish("arrow-click-pageturn");}}function g(){v(0);r();}function o(){v(t.length-1);r();}function n(){var J=e[e.length-1].artifactId;var K=J.indexOf("#");if(K>0){J=J.substr(0,K);}v(e.length-1);r(J);}function v(J){c=J;E();D();}function B(){a("#zoom").find(".restore").toggleClass("active");a("body").toggleClass("full-screen");if(a("body").hasClass("full-screen")){H=a(".viewer-section").hasClass("open");a(".viewer-section").removeClass("open");a("#toolbarControl").hide();a(".viewer-header").hide();a("body.full-screen #restore.icon").attr("title",ep.messages.standard_view);}else{d(false);}ep.publish("ebookViewer.resizeFullScreen");}function d(J){if(J){a("#zoom").find(".restore").removeClass("active");a("body").removeClass("full-screen");}a("#toolbarControl").show();a(".viewer-header").show();a("body #restore.icon").attr("title",ep.messages.full_screen_view);if(H){a(".viewer-section").addClass("open");}}function G(J){return(J>=0&&J<t.length);}function I(J){ep.debug("_zoom() triggered!!!");ep.publish("toolsZoom.ebookViewer",J);}function E(){s.value=t[c].label;if(u){u.slider("value",c);}else{if(f){f.slider("value",t[c].fileIndex);}}}function D(){var J,K,L=a("#zoom");if("EPUB"===A){J=t[c].fileIndex;K=e.length;}else{J=c;K=t.length;}if(J===K-1){L.find(".previousPage.inactive").removeClass("inactive").prop("disabled",false);L.find(".nextPage").addClass("inactive").prop("disabled",true);}else{if(c===0){L.find(".previousPage").addClass("inactive").prop("disabled",true);L.find(".nextPage.inactive").removeClass("inactive").prop("disabled",false);}else{L.find(".previousPage.inactive, .nextPage.inactive").removeClass("inactive").prop("disabled",false);}}}function F(K){var J=a("#zoom");if(K==="width"){J.find(".fit-width").addClass("active");J.find(".fit-page.active").removeClass("active");}else{if(K==="page"){J.find(".fit-page").addClass("active");J.find(".fit-width.active").removeClass("active");}}}function r(J){var K,M=("EPUB"===A)?ep.ebookViewer.dataManager.getPageByIndex(c).artifactId:"",L=("EPUB"===A)?M.indexOf("#"):-1;M=J||M.substring(0,L!==-1?L:M.length);ep.debug("tools:_notifyPageTurn("+M+")");a(document).trigger("toolsPageTurn.ebookViewer",[c,M]);}a(j);return{nextPdf:function(K){var L,J=c,M=[];K=K||1;while(K){K--;L=q(J);if(G(L)){M.push(L);J=L;}else{break;}}return M.length?M:null;},prevPdf:function(K){var L,J=c,M=[];K=K||1;while(K){K--;L=x(J);if(G(L)){M.push(L);J=L;}else{break;}}return M.length?M.reverse():null;},getCurrentPageLabel:function(){return s.value;},goToPageByIndex:function(J){h(J);}};})(jQuery));});(function(a){var e={};var f={};var b={};var i={};var c={};function d(){e=a(".selection-title");f=a("#source");b=a("#author");i=a("#date");c=a(".book-thumbnail");ep.subscribe("documentLoaded.ebookViewer",function(j){var k=j.theDoc;var l=j.thePage;g(k.title,k.authors,k.publicationYear,k.rootPath,k.id);h(l.title);},true);ep.subscribe("pageTurn.ebookViewer",function(j){var k=j.thePage;h(k.title);});ep.subscribe("eBookViewer.updateTitle",function(j){h(j);});c.bind("click",function(j){ep.publish("ebook-toc-click",ep.ebookViewer.dataManager.getPageByLpId(a(j.currentTarget).data().lpid));});}function g(m,j,n,l,k){f.text(m);document.title=m;b.text(j);i.text(n);}function h(j){if(e.text()!==j){e.text(j);}}a(d);})(jQuery);(function(a){var n=1*60000;var m=5*60000;var h;var g;var l;var f=false;var e=true;function d(){ep.subscribe("pageTurn.ebookViewer",function(){i(true);});ep.subscribe("toolsZoom.ebookViewer",function(){i(true);});ep.subscribe("pageViewed.ebookViewer",function(){i(true);});ep.subscribe("docReady.ebookViewer",function(){i(true);},true);a(document).delegate(".article-tools a, #ToolPanelContent a, #ToolPanelContent input, #ToolPanelContent button","click",function(o){i(false);});i(true);}function i(o){if(o){h=g=new Date().getTime();k();}else{g=new Date().getTime();if(!e){j();}}e=true;b();}function c(){k();var o=new Date().getTime();ep.debug("checkActivity(): ... lastRenew: "+(o-h)+" ... lastActivity: "+(o-g));if(o-h<m){b();}else{if(o-g<m){j();}else{e=false;ep.debug("checkActivity(): inactive user");}}}function j(){ep.debug("_renew(): time to renew now");a.ajax({url:ep.utilities.buildAjaxRequestPath("ebookViewer/renew",ep.clientData.currentRecord),cache:false,data:"an="+ep.ebookViewer.dataManager.currentDoc().an,dataType:"json",success:function(o){if(o===true){i(true);}else{if(o===false){ep.debug("_renew(): failed to renew checkout");}}}});}function b(){if(!f){l=setTimeout(c,n);f=true;}}function k(){if(l&&f){clearTimeout(l);f=false;}}a(d);})(jQuery);(function(a){var d="";var f=false;var g={};var b={};function e(){if(ep.clientData){b=ep.clientData.ebookViewer;}ep.subscribe("documentLoaded.ebookViewer",function(j){var k=j.theDoc;var l=j.thePage;if(!k.sourceFormat){d=b.format;}else{d=(k.sourceFormat==="PDF")?"EB":"EK";}},true);g=a("#accessibleContent");a("#accessibleContentLink").bind("click",function(j){j.preventDefault();if(ep.clientData.ebookPdfViewerPhase>0||(ep.clientData.ebookViewer.Format==="EK"&&ep.clientData.bookEpubViewerPhase>0)){j.currentTarget.blur();i(j.currentTarget.hash);return;}g.html("<div>&nbsp;</div>");c();i("#accessibleContent");});a("a[href='#accessibleViewport']").bind("click",function(j){j.preventDefault();i("#viewport");});a("a[href='#tocHeading']").bind("click",function(j){j.preventDefault();i("#tocHeading");});a("a[href='#ArticleTools']").bind("click",function(j){j.preventDefault();a(document).find("#ArticleToolBar li:first a").focus();});}function i(j){if(ep.clientData.ebookPdfViewerPhase<1||(ep.clientData.ebookViewer.Format=="EK"&&ep.clientData.bookEpubViewerPhase<1)){a(document).find(j).focus();}else{ep.publish("ebookViewer.focusOnEvsItem",j);}}function c(){if(!f){f=true;h(ep.ebookViewer.currentPage());ep.publish("accessibilityMode.ebookViewer");ep.subscribe("pageTurn.ebookViewer",function(j){var k=j.thePage;ep.debug("page turn - accessibility");h(k);});}}function h(j){a.ajax({url:ep.utilities.buildAjaxRequestPath("ebookViewer/artifactText",ep.clientData.currentRecord),data:{thePage:j.ppId,theFormat:d},dataType:"html",success:function(k){if(k){g.html(k);}}});}a(e);})(jQuery);(function(a){var e={};var g="";var f=[];function b(){e=a("#ViewerServiceFrame").get(0);g=ep.clientData.ebookVieweriFrameOrigin;f=ep.clientData.allowedOrigins;a(window).on("message onmessage",function(h){d(h.originalEvent);});ep.subscribe("ebookViewer.focusOnEvsItem",function(h){var i={theSignature:"ebookViewer.focusOnEvsItem",theArgs:h};c(i);},true);ep.subscribe("ep.ebookViewer.toolsInterface.ready",function(){var h={theSignature:"ep.ebookViewer.toolsInterface.ready",theArgs:null};c(h);},true);ep.subscribe("toolsZoom.ebookViewer",function(i){var h={theSignature:"toolsZoom.ebookViewer",theArgs:i};c(h);},true);ep.subscribe("arrow-click-pageturn",function(){var h={theSignature:"arrow-click-pageturn",theArgs:null};c(h);},true);ep.subscribe("epub:rangeSelected",function(h){var i={theSignature:"epub:rangeSelected",theArgs:h};c(i);},true);ep.subscribe("eBookViewer.documentZoomed",function(){var h={theSignature:"eBookViewer.documentZoomed",theArgs:null};c(h);},true);ep.subscribe("ebook-toc-click",function(i){var h={theSignature:"ebook-toc-click",theArgs:i};c(h);},true);ep.subscribe("ebook-searchwithin-click",function(i){var h={theSignature:"ebook-searchwithin-click",theArgs:i};c(h);},true);ep.subscribe("ebook-note-page-click",function(i){var h={theSignature:"ebook-note-page-click",theArgs:i};c(h);},true);ep.subscribe("epub:pageStatus",function(){var h={theSignature:"epub:pageStatus",theArgs:null};c(h);},true);a(document).bind("toolsPageTurn.ebookViewer",function(j,k,h){var i={theSignature:"toolsPageTurn.ebookViewer",theArgs:[k,h]};c(i);});a(document).bind("updatePermissions.ebookViewer",function(i){var h={theSignature:"updatePermissions.ebookViewer",theArgs:null};c(h);});ep.subscribe("ebookViewer.resizeFullScreen",function(){var h={theSignature:"eBookViewer.documentZoomed",theArgs:null};c(h);},true);}function c(h){e.contentWindow.postMessage(JSON.stringify(h),g);}function d(h){var i=JSON.parse(h.data);switch(i.theSignature){case"toolsPageTurn.ebookViewer":a(document).trigger("toolsPageTurn.ebookViewer",i.theArgs);break;case"pageTurn.ebookViewer":a(document).trigger("pageTurn",i.theArgs.thePage);ep.publish(i.theSignature,i.theArgs);break;case"pageTurn":a(document).trigger("pageTurn",i.theArgs);break;case"panelReady":a("#panelReady").trigger("panelReady",i.theArgs);break;case"resizePanel":a(window).trigger("resizePanel","notePanel");break;case"showMoreTools":a(window).trigger("showMoreTools");break;case"pageError.ebookViewer":a(document).trigger("pageError.ebookViewer",i.theArgs);break;case"ebookViewer.getCitation":var j={theSignature:"ebookViewer.receiveCitation",theArgs:ep.clientData.bkCitation};c(j);break;default:ep.publish(i.theSignature,i.theArgs);}}a("#ViewerServiceFrame").ready(function(){a(b);});})(jQuery);(function(a){a.widget("ui.eppanel",{options:{Panel:"#ToolPanelContent",Id:"",Url:"",Js:""},_eventNamespace:"",_panel:{},_isOpen:false,_isInProg:false,_panelUrl:"",_create:function(){ep.debug("eppanel:create");this._setNamespace();this._panel=a(this.options.Panel);var b=this;this._panel.find(".close-panel").bind("click",function(c){b._closeClickHandler(c);});this._panel.bind("panelReady"+this._eventNamespace,function(c,d,e){if(d!==b.options.Id){ep.debug("trigger: panelOnClose - "+b.options.Id);b._panel.trigger("panelOnClose",b.options.Id);b.destroy();}else{ep.debug("No longer in progress "+b.options.Id);b._inProg=false;}});this._panel.bind("panelClose"+this._eventNamespace,function(c,d){if(d===b.options.Id){b._close();}});},_setNamespace:function(){if(this.options.Id&&this.options.Id.length>0){this._eventNamespace=".eppanel-"+this.options.Id;}else{this._eventNamespace=".eppanel-"+Math.floor(Math.random()*1001);}},_init:function(){if(this._isOpen){ep.debug("trigger: panelOnClose - "+this.options.Id);this._panel.trigger("panelOnClose",this.options.Id);this._close();}else{this._open();}},_open:function(){ep.debug("eppanel:open "+this.options.Id);if(!this._isInProg){this._isInProg=true;this.element.parent().addClass("active bg-p2");this._setPanelUrl();this._getContent();}},_close:function(){ep.debug("eppanel:close "+this.options.Id);var b=window.location.href.indexOf("/ebookviewer/ebook")>-1;if(this._isOpen){if(ep.clientData.iSEVSCSSRefreshEnabled&&b){this._panel.removeClass("panel-open");}else{this._panel.hide();}this._panel.find(".close-panel").unbind();this._panel.resize();this.destroy();this._isOpen=false;}},destroy:function(){ep.debug("eppanel:destroy "+this.options.Id);this.element.parent().removeClass("active bg-p2");a(document).unbind(this._eventNamespace);this._panel.unbind(this._eventNamespace);a.Widget.prototype.destroy.call(this);a(window).trigger("panelClose:resize",this.options.Id);},_closeClickHandler:function(b){this._close();},_setPanelUrl:function(){if(this.options.Url.indexOf("?")!==-1){var b=ep.utilities.buildRouteKey(ep.clientData.currentRecord.Db,ep.clientData.currentRecord.Term,ep.clientData.currentRecord.Tag);this._panelUrl=this.options.Url+"&recordKey="+b;if(ep.newReturnUrl){this._panelUrl+="&ReturnUrl="+encodeURIComponent(ep.newReturnUrl);}}else{this._panelUrl=ep.utilities.buildAjaxRequestPathWithNewReturn(this.options.Url,ep.clientData.currentRecord);}},_getContent:function(){var b=this;a.ajax({url:this._panelUrl,dataType:"html",success:function(c){b._updatePanel(c);b._loadJs();b._notify();b._panel.find(":tabbable").first().focus();b._isOpen=true;a(window).trigger("panelOpen:resize",b.options.Id);}});},_doEmptyWrapper:function(){var b=this._panel.children(".wrapper");if(b.children().length){b.empty();}},_updatePanel:function(d){var b=this._panel.children(".wrapper");var c=window.location.href.indexOf("/ebookviewer/ebook")>-1;this._doEmptyWrapper();b.append(d);if(ep.isPageRTL()){ep.utilities.bidiSanitizeContent(b.get(0));}if(ep.clientData.iSEVSCSSRefreshEnabled&&c){this._panel.addClass("panel-open");}else{this._panel.show();}this._panel.find("a.close-panel").show();this._panel.resize();},_loadJs:function(){if(this.options.Js&&this.options.Js!==""){ep.require(this.options.Js);}},_notify:function(){ep.debug("trigger: panelReady - "+this.options.Id);this._panel.trigger("panelReady",this.options.Id);}});a(function(){a(document).delegate("[data-panel]","click",function(d){var c=a(d.currentTarget);var b=c.data("panel");c.eppanel(b);d.preventDefault();return false;});});})(jQuery);jQuery(function(){ep.require("jquery/plugins/jquery.validate-1.9.0.js",function(){(function(a){a.widget("ui.pagingwidget",{itemList:{},widgetElement:{},items:{},pageCount:{},prevLink:false,nextLink:false,pageLinkList:{},options:{pagingElement:{},pagingOptions:{itemsPerPage:10,visiblePageLinks:3,previousLinkText:"&laquo;",previousLinkTitle:"Previous",nextLinkText:"&raquo;",nextLinkTitle:"Next",itemTypeText:"items"}},_create:function(){this.itemList=a(this.element);this.widgetElement=a(this.options.pagingElement);this.items=this.itemList.find("li");if(this.widgetElement&&this.items){this.initializePaging(null);}},_init:function(){},destroy:function(){a.Widget.prototype.destroy.call(this);},initializePaging:function(k){if(k){this.itemList=k;this.items=this.itemList.find("li");}if(this.widgetElement&&this.itemList&&this.items){this.pageCount=Math.ceil(this.items.length/this.options.pagingOptions.itemsPerPage);if(this.pageCount===1){this.widgetElement.hide();}else{var e="";this.options.pagingOptions.itemsPerSet=this.options.pagingOptions.itemsPerPage*this.options.pagingOptions.visiblePageLinks;var c=this.options.pagingOptions;if(this.pageCount>c.visiblePageLinks){var g='<a class="prev-page" data-auto="prev_pagearticles_link" href="#" title="{0} {1} {2}">{3}<span style="display: none;"> {4} {5} {6}</span></a>';e+=jQuery.validator.format(g,c.previousLinkTitle,c.itemsPerSet,c.itemTypeText,c.previousLinkText,c.previousLinkTitle,c.itemsPerPage,c.itemTypeText);this.prevLink=true;}e+='<ol class="paging-links">';var d={start:0,end:0,title:c.itemTypeText};for(var h=0;h<this.pageCount;h+=1){d.start=((h*c.itemsPerPage)+1);d.end=((h+1)*c.itemsPerPage);d.end=d.end>this.items.length?this.items.length:d.end;var f='<li><a href="#" data-auto="paging_link" title="{0} {1} - {2}"><span style="display: none;">{3} </span>{4} - {5}</a></li>';e+=jQuery.validator.format(f,d.title,d.start,d.end,d.title,d.start,d.end);}e+="</ol>";if(this.pageCount>c.visiblePageLinks){var b='<a class="next-page" data-auto="next_pagearticles_link" href="#" title="{0} {1} {2}"><span style="display: none;">{3} {4} {5} </span>{6}</a>';e+=jQuery.validator.format(b,c.nextLinkTitle,c.itemsPerSet,c.itemTypeText,c.nextLinkTitle,c.itemsPerPage,c.itemTypeText,c.nextLinkText);this.nextLink=true;}this.widgetElement.append(e);this.pageLinkList=this.widgetElement.children("ol.paging-links");var j=this;if(this.prevLink){this.prevLink=this.widgetElement.children("a.prev-page");this.prevLink.click(function(i){i.preventDefault();j.showPreviousPage();});}if(this.nextLink){this.nextLink=this.widgetElement.children("a.next-page");this.nextLink.click(function(i){i.preventDefault();j.showNextPage();});}this.pageLinkList.find("li a").each(function(i){a(this).click(function(l){l.preventDefault();j.showPage(j.pageLinkList.find("li").index(a(l.target).parents("li")));});});this.widgetElement.show();this.showPage(0);}}},getActivePageIndex:function(){var b=this.pageLinkList.children("li.active");return this.pageLinkList.find("li").index(b);},showPreviousPage:function(){var b=this.options.pagingOptions;this.showPage((Math.floor(this.getActivePageIndex()/b.visiblePageLinks)*b.visiblePageLinks)-1);},showNextPage:function(){var b=this.options.pagingOptions;this.showPage((Math.floor(this.getActivePageIndex()/b.visiblePageLinks)*b.visiblePageLinks)+b.visiblePageLinks);},showPage:function(g){var d=this.options.pagingOptions;if(this.pageCount>1){var f=this.pageLinkList.find("li");if(g<0||g>f.length){g=0;}var e=(Math.floor(g/d.visiblePageLinks)*d.visiblePageLinks);f.each(function(h){a(this).removeClass("active");if(h===g){a(this).addClass("active");}if(h>=e&&h<(e+d.visiblePageLinks)){a(this).show();}else{a(this).hide();}});this.items.each(function(h){if(h>=(g*d.itemsPerPage)&&h<((g+1)*d.itemsPerPage)){a(this).show();}else{a(this).hide();}});if(this.prevLink){if(g>=d.visiblePageLinks){this.prevLink.show();}else{this.prevLink.hide();}}var b=((Math.ceil(f.length/d.visiblePageLinks)*d.visiblePageLinks)-d.visiblePageLinks);if(this.nextLink){if(f.length>d.visiblePageLinks&&g<b){this.nextLink.show();}else{this.nextLink.hide();}}var c=this.items.parent();if(c.get(0).tagName==="OL"){c.attr("start",(g*d.itemsPerPage)+1);}}},setActiveItems:function(e,c){if(this.itemList){var d=this.itemList;d.find("li").removeClass("active");var b=null;if(!a.isArray(e)){e=[e];}a(e).each(function(f,g){if(g){if(!c){a(g).addClass("active");b=null;}if(!b){b=d.find("li").index(g);}}});if(b!==null){this.showPage(Math.floor(b/this.options.pagingOptions.itemsPerPage));}}},clear:function(){if(this.prevLink){this.prevLink.remove();this.prevLink=null;}if(this.nextLink){this.nextLink.remove();this.nextLink=null;}if(this.pageLinkList){this.pageLinkList.remove();this.pageLinkList=null;}this.items=null;}});})(jQuery);});});(function(a){a.widget("ui.epeditor",{options:{toolbarOptions:null,height:null},_create:function(){ep.debug("initializing ckeditor");var b=[];if(this.options.toolbarOptions!==null){b=this.options.toolbarOptions;}else{b=[["Bold","Italic","Underline","-","Undo","Redo"]];}if("rtl"===a("html").attr("dir")){b[0].push("-");b[0].push("BidiLtr");b[0].push("BidiRtl");}var c=(a("html").attr("lang"))?a("html").attr("lang"):null;var d={toolbar:b,skin:"epskin"};if(this.element.data("important")){d.toolbar=[{name:"basicstyles",items:["Bold","Italic","Underline"]},{name:"links",items:["Link","Unlink"]}];}if(this.options.height!==null){d.height=this.options.height;}CKEDITOR.on("instanceReady",function(e){a("iframe.cke_wysiwyg_frame",e.editor.container.$).contents().on("click",function(){e.editor.focus();});});this.element.ckeditor(a.noop,d);},_init:function(){this.editorInterval=setInterval(function(){a(window).trigger("editorIntervalCheck");},500);this.element.ckeditor(function(){this.focus();});},destroy:function(){clearInterval(this.editorInterval);var b=this;b.element.ckeditor(function(){this.destroy();});a.Widget.prototype.destroy.call(b);}});})(jQuery);(function(a){a(function(){var b=a(".column1-open #column1"),e=a("#column2"),l=(a(document).find('link[media*="(max-device-width: 600px)"]').length&&/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent))?600:-1;if(!b.children().length){return;}var k=a("#viewport"),g=(a("#ViewerColumn").length?a("#ViewerColumn"):a("#content")),j,d=216,c=371;if(a(window).width()>l){g.resizable({handles:"w"});}j=a(".ui-resizable-handle");if(j.length){j.mousedown(function(){k.hide();});j.mouseup(function(){k.show();});var h=j.outerWidth(),f=e.outerWidth(),i=b.outerWidth();g.bind("resizestop",function(r,s){var o=a("#column2");f=o.outerWidth();if(!a("body").hasClass("full-screen")){var n=(s.position.left),q=a(window).width(),m=parseFloat(a("body").css("min-width")),p=0;p=q>m?q:m;if(n>=d&&n<=c){b.width(n);g.css({width:(p-n-h-f),left:n-h});}else{if(n<d){b.width(d);g.css({width:(p-d-h-f),left:d-h});}else{if(n>c){b.width(c);g.css({width:(p+h-c-f),left:c-h});}}}}k.show();});a(window).on("resize.truncation",function(m){if(m.namespace==="truncation"){g.trigger("resizestop",{position:{left:a(".column1-open #column1").outerWidth()}});}});a(window).resize(function(){if(!a("body").hasClass("full-screen")){var o=a(window).width(),m=parseFloat(a("body").css("min-width")),n=0;n=o>m?o:m;if(n>l){g.width(n-b.outerWidth()-h-f);}}});}});})(jQuery);/*
 * jQuery resize event - v1.1 - 3/14/2010
 * http://benalman.com/projects/jquery-resize-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
(function($,k,j){var a=$([]),b=$.resize=$.extend($.resize,{}),i,g="setTimeout",f="resize",d=f+"-special-event",e="delay",h="throttleWindow";b[e]=250;b[h]=true;$.event.special[f]={setup:function(){if(!b[h]&&this[g]){return false;}var l=$(this);a=a.add(l);$.data(this,d,{w:l.width(),h:l.height()});if(a.length===1){c();}},teardown:function(){if(!b[h]&&this[g]){return false;}var l=$(this);a=a.not(l);l.removeData(d);if(!a.length){clearTimeout(i);}},add:function(l){if(!b[h]&&this[g]){return false;}var n;function m(p,s,r){var q=$(this),o=$.data(this,d);if(!o){o=$.data(this,d,{});}o.w=s!==j?s:q.width();o.h=r!==j?r:q.height();n.apply(this,arguments);}if($.isFunction(l)){n=l;return m;}else{n=l.handler;l.handler=m;}}};function c(){i=k[g](function(){a.each(function(){var m=$(this),o=m.width(),n=m.height(),l=$.data(this,d);if(o!==l.w||n!==l.h){m.trigger(f,[l.w=o,l.h=n]);}});c();},b[e]);}})(jQuery,this);(function(a){var k=16,b=false,c=_.debounce(i,300);function j(){var o=a(window).outerHeight()-a(".viewer-footer").outerHeight()-36;var n=a("body").hasClass("full-screen");if(ep.clientData.ebookPdfViewerPhase<2){if(!n){o=o-a("#toolbarControl").outerHeight()-a(".viewer-header").outerHeight();}a(".viewer-body, #LeftPanelContent").css("height",o+"px");if(a("#viewport iframe").length>0){if(b){a("#viewport").css("height",o-a("#ToolPanelContent").outerHeight()+"px");}else{a("#viewport").css("height","100%");}}}}function e(){var n=a(window).outerHeight();a("#LeftPanelContent").css("height",n+"px");}function h(){if(ep.clientData.ebookPdfViewerPhase<2){var n=a("#LeftPanelContent").outerHeight()-a(".source.wrapper").outerHeight()-a(".toc-heading").outerHeight()-k;}else{var n=a(this).outerHeight()-a(".source.wrapper").outerHeight()-a(".toc-heading").outerHeight()-k-100;}a(".toc-content").css("height",n+"px");}function g(){if(ep.clientData.ebookPdfViewerPhase<2){var n=a("#LeftPanelContent").outerHeight()-a(".evt-search-within").outerHeight()-a("#SearchWithinResults .evt-panel-group-b").outerHeight()-k;}else{var n=a(".toc-content").height()-a(".evt-search-within").outerHeight()-a("#SearchWithinResults .evt-panel-group-b").outerHeight();}a(".panel-result-list").css("height",n+"px");}function d(){var n=parseInt(a(".evt-notes-list").css("marginTop"),10)||0;if(ep.clientData.ebookPdfViewerPhase<2){var o=a("#LeftPanelContent").outerHeight()-a(".evt-notes-tools").outerHeight()-a("#NoteResults .evt-panel-group-b").outerHeight()-n-k;}else{var o=a(".toc-content").height()-a(".evt-notes-tools").outerHeight()-a("#NoteResults .evt-panel-group-b").outerHeight()-n;}a(".evt-notes-list").css("height",o+"px");}function i(){var p=0,n=a(".viewer-delivery").width()-(parseInt(a(".viewer-deliver").css("paddingLeft"),10)||0),o=a(".evt-more");if(a("#ViewerWrap").hasClass("show-tools-overlay")){return;}a(".viewer-delivery").children().each(function(){var q=a(this).outerWidth(true);p+=q;if(p>n){a(this).addClass("hidden");a(this).find("a").attr("tabindex","-1");a(o).detach().insertAfter("#ArticleToolBar li:not('.hidden'):last");a(o).attr("aria-expanded","false");}else{a(this).removeClass("hidden");a(this).find("a").attr("tabindex","0");a(o).attr("aria-expanded","true");}});if(a(".viewer-delivery").find(".hidden").length){a(o).removeClass("hidden").attr("tabindex","0");}else{a(o).addClass("hidden").attr("tabindex","-1");}}function m(){if(a(".viewer-delivery").find(".hidden").length){a(".viewer-delivery").removeClass("no-wrap");a(".viewer-delivery").find(".hidden").removeClass("hidden");}else{a(".viewer-delivery").addClass("no-wrap");i();}}function f(n){if(a(".show-contents-overlay, .show-tools-overlay").length){if(n){if(a(n.target).width()<996){e();}else{j();a("#viewport").removeClass("hidden");}}else{e();}}else{j();}h();g();d();c();}function l(){a(window).on("resize",f);a(window).on("resizePanel",function(o,p){if(p==="notePanel"){d();}});a(window).on("showMoreTools",function(){m();});a(window).on("resizeToolsBar",function(){i();});function n(o,p){switch(p){case"bookmark":case"permalink":case"export":case"dictionary":case"cite":case"save":case"print":case"email":if(o.type==="panelOpen:resize"){b=true;a("#viewport").css("height",a(".viewer-body").height()-a("#ToolPanelContent").outerHeight()+"px");}else{b=false;a("#viewport").css("height","100%");}break;default:break;}}a(window).on("panelOpen:resize panelClose:resize",function(o,p){if(a("#viewport iframe").length>0){n(o,p);}});}a(f);l();ep.subscribe("ebookViewer.resizeFullScreen",f);ep.subscribe("ebookViewer.resizeSearchWithin",g);ep.subscribe("ebookViewer.resizeOverlays",f);ep.subscribe("accessibilityMode.ebookViewer",function(){a(window).off();a("#viewport").css("height","auto");a("#LeftPanelContent").css("height","auto");a(".toc-content").css("height","auto");a(".panel-result-list").css("height","auto");a(".evt-notes-list").css("height","auto");});})(jQuery);(function(a){function b(){var d=/(iPad|iPhone|iPod)/g.test(navigator.userAgent),e=d?"pagehide":"beforeunload";a(window).on(e,function(f){c(ep.clientData.currentRecord.Term);});}function c(d){a.ajax({type:"POST",url:ep.utilities.buildAjaxRequestPath("CheckoutDialog/CheckInItem"),data:{an:d},async:false});}a(b);})(jQuery);ep.register("ep.ebookViewer.ifrmPageWatcher",(function(a){var i=true;var k,j;var d;var c;var e;function f(){i=false;}function h(){if(!i){if(k&&j){i=true;b(c,k,j,true);}}}function g(){if(!i){if(k&&j){i=true;b(c,k,j,false);}}}function b(t,v,n,p){var r=5;var q=1*1000;function o(F,E){var y=false;var C,B;var D,x,A;for(var z=0;i&&z<d.length;z++){C=d[z].yOffset;B=d[z].yExtent;D=((F<=C)&&(E>=C));x=((F<=B)&&(E>=B));A=((C<F)&&(B>E));y=(D||x||A);if(y){d[z].secondsObserved++;if(r<d[z].secondsObserved&&!d[z].reported){n(d[z].markerName,true);d[z].reported=1;}}else{if(d[z].reported){d[z].secondsObserved=d[z].reported=0;n(d[z].markerName,false);}}}}function u(){var y=a(c).scrollTop();var x=y+a("#viewport").height();o(y,x);if(i){setTimeout(u,q);}}c=t;k=v;j=n;if(!p){var s;var w;d=[];a(v,c).each(function(y,x){w=m(x);s=a(this).attr("data-ep_ppid");d.push({markerName:s,yOffset:w,secondsObserved:0,reported:0});if(y){d[y-1].yExtent=w-1;}});if(d.length){d[d.length-1].yExtent=a(c).height();}}if(a("body",c).is(":visible")){u();}else{i=false;}}function m(n){var o=n.getBoundingClientRect().top;var p=parseInt(a(n).css("margin-top"),10);return o-p+e.pageYOffset;}function l(){var z={};var s=a("*[data-ep_lpid]",c);var x=a("*[data-ep_ppid]",c);var r,v;var w,y;var A=a(c).scrollTop();var p=A+10;var q;if(s.length){var t;var u;t=""+a(s.get(0)).data("ep_lpid");u=t.split(",");z.logicalPart=u[u.length-1];var n=m(s.get(0));for(q=s.length-1;q>=0;q--){r=s.get(q);v=m(r);t=""+a(r).data("ep_lpid");u=t.split(",");z.logicalPart=u[u.length-1];if((v<=p)||(v===n)){break;}}}var o=a("*[id^=ep-file-]",c);z.fileIndex=o.length?a(o[0]).attr("id"):0;for(q=x.length-1;q>=0;q--){w=x.get(q);y=m(w);z.ppid=""+a(w).data("ep_ppid");if(y<=p){break;}}return z;}ep.subscribe("epub:iframeready",function(){var p;var o;var n=true;p=jQuery("#ePubFrame").get(0);e=p.contentWindow;o=(p.contentWindow||p.contentDocument);if(o.document){o=o.document;}function q(u,s){var t={};t.bState=s;t.turnedPageIdentifier=u;t.doc=o;ep.publish("epub:pageStatus",t);}if(n){var r="*[data-ep_ppid]";ep.ebookViewer.ifrmPageWatcher.pageContentWatcher(o,r,q,true);}});return{pageContentWatcher:function(n,p,o){return b(n,p,o);},whereAreWe:function(n){return l(n);},pause:function(){f();},resume:function(){h();},restart:function(){g();}};})(jQuery));ep.register("ep.ebookViewer.epubIframe",(function(a){var l;var m;var c=true;function p(F){ep.debug(F);}function r(G,H){var F=false;if(F){ep.debug(G+": "+H);}}function u(F){return a(F).offset().left;}function v(F){return a(F).offset().top;}function w(F){return a(F).width();}function t(F){return a(F).height();}function f(I,L,M,P){var G=P||"";var F=true;var J;if(F){ep.debug("encodeCFI(start): node.nodeType = "+L.nodeType);ep.debug("encodeCFI(start): offset = "+M);}if(L.nodeType===1){if(typeof M==="number"){L=L.childNodes.item(M);}}else{M=M||0;while(true){var N=L.previousSibling;if(F){if(N){ep.debug("encodeCFI(): p = "+N.nodeType);}else{ep.debug("encodeCFI(): p = null, breaking!");}}if(!N||N.nodeType===1){break;}switch(N.nodeType){case 3:case 4:case 5:M+=N.nodeValue.length;if(F){ep.debug("encodeCFI(): bumping offset = "+M);}}L=N;}G=":"+M+G;}if(F&&L){ep.debug("encodeCFI(finally): node.nodeType = "+L.nodeType);ep.debug("encodeCFI(finally): offset = "+M);J=L.tagName?"<"+L.tagName+">":"[unknown tag]";ep.debug("encodeCFI(finally): leaf tagName = "+J);}while(L!==I){if(F){ep.debug("encodeCFI(tree-up): node.nodeType = "+L.nodeType);J=L.tagName?"<"+L.tagName+">":"[unknown tag]";ep.debug("encodeCFI(tree-up): node.tagName = "+J);}var O=L.parentNode;if(!O){if(L.nodeType===9){var Q=L.defaultView;if(Q.frameElement){L=Q.frameElement;G="!"+G;continue;}}break;}if(F){J=O.tagName?"<"+O.tagName+">":"[unknown tag]";ep.debug("parent tagName = "+J);}var K=0;var H=O.firstChild;if(!H){H=L;}if(F){J=H.tagName?"<"+H.tagName+">":"[unknown tag]";ep.debug("child tagName = "+J);}while(H){K|=1;if(H.nodeType===1){K++;}if(H===L){break;}H=H.nextSibling;}if(L.id&&L.id.match(/^[\-a-zA-Z_0-9.\u007F-\uFFFF]+$/)){K=K+"["+L.id+"]";}G="/"+K+G;L=O;}return G;}function n(F){var G=F.split("!");var H=(G.length>1)?G[1]:G[0];G=H.split(",");return G.length>1;}function e(H,F){var N=H;var I;var Q;r("decodeCFI","cfi = "+F);while(F.length>0||I){if((Q=F.match(/^\/(\d+)(\[([\-a-zA-Z_0-9.\u007F-\uFFFF]+)\])?/))!==null){var R=Q[1]-0;var J=Q[3];var K=0;var G=N.firstChild;r("decodeCFI(/^\\/(\\d+)(\\[([-a-zA-Z_0-9.\\u007F-\\uFFFF]+)\\])?/)",Q);while(true){if(!G){I="child not found: "+F;break;}K|=1;if(G.nodeType===1){K++;}if(K===R){F=F.substr(Q[0].length);N=G;if(J?N.id!==J:N.id){p("id mismatch: '"+J+"' and '"+N.id+"'");}break;}G=G.nextSibling;}}else{if((Q=F.match(/^!/))!==null){r("decodeCFI(/^!/)",Q);if(N.contentDocument){N=N.contentDocument;F=F.substr(1);}else{I="Cannot reference "+N.nodeName+"'s content: "+F;r("decodeCFI",I);}}else{break;}}}var O=null;var P={};if((Q=F.match(/^:(\d+)/))!==null){r("decodeCFI(/^:(\\d+)/)",Q);O=Q[1]-0;F=F.substr(Q[0].length);}if((Q=F.match(/^~(-?\d+(\.\d+)?)/))!==null){r("decodeCFI(/^~(-?\\d+(\\.\\d+)?)/)",Q);P.time=Q[1]-0;F=F.substr(Q[0].length);}if((Q=F.match(/^@(-?\d+(\.\d+)?),(-?\d+(\.\d+)?)/))!==null){r("decodeCFI(/^@(-?\\d+(\\.\\d+)?),(-?\\d+(\\.\\d+)?)/)",Q);P.x=Q[1]-0;P.y=Q[3]-0;F=F.substr(Q[0].length);}if((Q=F.match(/^\[.*(;s=[ab])?.*\]/))!==null){r("decodeCFI(/^\\[.*(;s=[ab])?.*\\]/)",Q);if(Q[1]){P.forward=Q[0]==="s=a";F=F.substr(1);}}if(O!==null){while(true){var L=N.nodeValue.length;if(O<L||(!P.forward&&O===L)){break;}var M=N.nextSibling;while(true){var S=M.nodeType;if(S===3||S===4||S===5){break;}if(S===1){M=null;break;}M=M.nextSibling;}if(!M){if(O>L){I="Offset out of range: "+O;O=L;r("decodeCFI",I);}break;}N=M;O-=L;}P.offset=O;}P.node=N;if(I){P.error=I;}else{if(F.length>0){P.error="Undecoded: "+F;}}if(P.error){p(P.error);}return P;}function h(F){var H="";if(F<0){H="-";F=-F;}var G=Math.floor(F);H+=G;G=Math.round((F-G)*100);if(G!==0){H+=".";if(G%10===0){H+=(G/10);}else{H+=G;}}return H;}function d(I,Q,R){var P;var G=I;var H=G.defaultView;var O="";var K=null;var J;while(true){P=G.elementFromPoint(Q,R);if(!P){p("no element at point");return null;}J=P.localName;if(J!=="iframe"&&J!=="object"&&J!=="embed"){break;}var F=P.contentDocument;if(!F){break;}Q=Q+H.scrollX-u(P);R=R+H.scrollY-v(P);G=F;H=G.defaultView;}if(J==="video"||J==="audio"){O="~"+h(P.currentTime);}if(J==="img"||J==="video"){var L=((Q+H.scrollX-u(P))*100)/P.offsetWidth;var M=((R+H.scrollY-v(P))*100)/t(P);O=O+"@"+h(L)+","+h(M);}else{if(J!=="audio"){if(G.caretRangeFromPoint){var N=G.caretRangeFromPoint(Q,R);if(N){P=N.startContainer;K=N.startOffset;ep.debug("cfiAt(): offset set from range = "+K);}}else{ep.debug("Trouble in River City!!!");}}}return f(I,P,K,O);}function x(H,G){var O=e(H,G);var P;if(!O){return null;}var L=O.node;var K=L.ownerDocument;if(!K){p("document");return null;}var N=K.defaultView;var U;var V;if(typeof O.offset==="number"){if(c){P=rangy.createRange(l);}else{P=K.createRange();}if(O.forward){tryList=[{start:0,end:0,a:0.5},{start:0,end:1,a:1},{start:-1,end:0,a:0}];}else{tryList=[{start:0,end:0,a:0.5},{start:-1,end:0,a:0},{start:0,end:1,a:1}];}var J=0;var F;var M=(L.nodeValue)?L.nodeValue.length:a(L).text().length;do{if(J>=tryList.length){p("no caret position: "+rects);return null;}var T=tryList[J++];var S=O.offset+T.start;var I=O.offset+T.end;F=T.a;if(S<0||I>=M){continue;}P.setStart(L,S);P.setEnd(L,I);if(c){var R=rangy.getIframeSelection(a("#ePubFrame").get(0));R.setSingleRange(P);rects=[P.getBoundingClientRect()];}else{rects=P.getClientRects();}}while(!rects||!rects.length);var Q=rects[0];U=(F*Q.left+(1-F)*Q.right);V=(Q.top+Q.bottom)/2;}else{U=u(L)-N.scrollX;V=v(target)-N.scrollY;if(typeof O.x==="number"&&L.offsetWidth){U+=(O.x*L.offsetWidth)/100;V+=(O.y*t(L))/100;}}while(K!==H){L=N.frameElement;K=L.ownerDocument;N=K.defaultView;U+=u(L)-N.scrollX;V+=v(target)-N.scrollY;}return{x:U,y:V,node:O.node,time:O.time,theRange:P||{}};}function B(F){if(window.cfi){var H=x(document,window.cfi);var G=document.getElementById("marker1").style;if(H){G.visibility="visible";G.top=(H.y-30)+window.scrollY+"px";G.left=(H.x-1)+window.scrollX+"px";if(!F){if(typeof H.time==="number"){H.node.currentTime=H.time;}scrollTo(0,H.y-30);}}}}function q(F){window.cfi=d(document,F.clientX,F.clientY);B(true);if(window.cfi){setTimeout(function(){location.replace(location.href.replace(/#.*$/,"")+"#epubcfi("+window.cfi+")");},1000);}}function k(){window.onscroll=B;window.onresize=B;var G=document.getElementsByTagName("iframe");for(var H=0;H<G.length;H++){var F=G.item(H);F.contentWindow.onscroll=B;}var I=location.hash.match(/#epubcfi\((.*)\)$/);if(I){window.cfi=decodeURI(I[1]);setTimeout(B,10);}}function y(I,F){var K=F.split("!");var L=(K.length>1)?K[1]:K[0];K=L.split(",");var J=[];var G,H;if(!n(F)){J.push(x(I,L));}else{if(K.length===2){G=K[0];H=K[1];r("pointsFromCFI","cfiA = "+G);r("pointsFromCFI","cfiB = "+H);J.push(x(I,G));J.push(x(I,H));}else{if(K.length===3){G=K[0]+K[1];H=K[0]+K[2];r("pointsFromCFI","cfiA = "+G);r("pointsFromCFI","cfiB = "+H);J.push(x(I,G));J.push(x(I,H));}}}return J;}function A(G,F){var I={};if(n(F)){var H=y(document,F);I.anchorNode=H[0].node;I.anchorOffset=H[0].theRange.startOffset;I.focusNode=H[1].node;I.focusOffset=H[1].theRange.startOffset;return I;}return null;}function i(H,G){var I=[],J=/^\s*$/;function F(M){if(M.nodeType===3){if(G||!J.test(M.nodeValue)){I.push(M);}}else{for(var K=0,L=M.childNodes.length;K<L;++K){F(M.childNodes[K]);}}}F(H);return I;}function C(F,J){ep.debug("zoomDocument(): zoomDelta = "+J);var H=i(a("body",F).get(0),false);var G=[];var I={};a.each(H,function(L,K){var M=a(K).parent().html();var N=(a(K).parent().text().indexOf("its final stop at the grocery")>=0);if(N){var O=1;}if(!I[M]){I[M]=true;G.push({parentId:M,element:a(K).parent().get(0)});}});a.each(G,function(L,K){var P=a(K.element).css("font-size");var M=(a(K.element).text().indexOf("its final stop at the grocery")>=0);if(P&&P.length){var O=parseFloat(P);var N;if(M){ep.debug("node["+L+"] font-size = "+P);}O=O+O*J/100;if(M){ep.debug("new font-size = "+O);}if(P.split("px").length>1){N=O+"px";}else{if(P.split("%").length>1){N=O+"%";}else{N=O+"em";}}a(K.element).css("font-size",N);}});}function o(){return(this.nodeType===3);}function s(){return(this.tagName.toLowerCase()!=="p");}function j(){return(a(this).text().length>0);}function z(G,F,O){var M=a(F).css("font-size"),K=a(F).css("line-height"),L,I,J=["px","%","em","pt","cm","mm","in","pc"],N,H=function(Q){var P=false;P=((typeof(Q)==="string")&&parseFloat(Q));return P;};if(M&&M.length){L=parseFloat(M);I=L=L+L*O/100;_.each(J,function(P){if(M.slice(-P.length)===P){I=L+P;}});a(F).css("font-size",I);if(H(K)){L=parseFloat(K);I=""+L;_.each(J,function(P){if(K.slice(-P.length)===P){I=""+(L+L*O/100)+P;}});a(F).css("line-height",I);}}}function E(F,H){ep.debug("zoomDocument(): zoomDelta = "+H);var G=a(F.body).children().filter(j);a.each(G,function(J,I){z(J,I,H);});}function g(J,I,N){if(I){var G=100;var L=25;var M=20;ep.debug("epubPageZoom "+J);var H=a("body").attr("data-zoom");if(H&&!N){G=parseInt(H,10);}var F;F=(N)?N:G+(J==="in"?L:-M);var K;if(F>0){K=F-G;a("body").attr("data-zoom",""+F);E(I,K);}}}function D(F){ep.debug("zoom caught!!!");g(F,l);}ep.subscribe("epub:iframeready",function(af){var W=500;var X=-3000;var an;var R;var H="never";var G=false;var U=false;var T=af.isCopyProtected;_.templateSettings={interpolate:/\#\{(.+?)\}/g};function aj(){var ax=a("#ePubFrame").get(0);if(ax){var ay=a(ax).contents().find("p:visible").get(0);var az=rangy.createRange(l);az.selectNodeContents(ay);var aA=rangy.getIframeSelection(ax);aA.setSingleRange(az);setTimeout(aj,X);}}if(X>0){aj();}function L(){var ay=null;var ax=null;R.focus();an=rangy.getIframeSelection(m);if(!an.anchorNode){return;}an.refresh();var aC=rangy.createRangyRange(l);if(an.isBackwards()){aC.setStart(an.focusNode,an.focusOffset);aC.setEnd(an.anchorNode,an.anchorOffset);}else{aC.setStart(an.anchorNode,an.anchorOffset);aC.setEnd(an.focusNode,an.focusOffset);}ep.debug("BEFORE Adjustment, range selection: %s to %s",aC.startContainer,aC.endContainer);var aA=null;var aB=null;function az(aF){var aD=null;var aE=false;if(!aF||0===a(aF).contents().length){return null;}a(aF).contents().each(function(aH,aG){if(!aE&&3===aG.nodeType&&a(aG).text().trim().length){aE=true;aD=aG;}});if(!aE&&a(aF).children().length){return az(a(aF).children().get(0));}return aD;}if(a(aC.startContainer).get(0).nodeType!==3){aA=az(aC.startContainer);if(aA){aC.setStart(aA,0);if(false){a(aC.startContainer).contents().each(function(aE,aD){ep.debug("contained nodeType = %d",aD.nodeType);if(3===aD.nodeType){aB=aD;}});}else{if(aC.startContainer!==aC.endContainer){aB=a(aA).parent().nextAll(":last").get(0).firstChild;}else{aB=aA;}}aC.setEnd(aB,a(aB).text().length);}else{return;}}ep.debug("AFTER Adjustment, range selection: %s to %s",aC.startContainer,aC.endContainer);if(aC.startContainer&&((aC.startContainer!==aC.endContainer)||(aC.startOffset!==aC.endOffset))){ep.debug("(I) rangyRange.startContainer = "+a(aC.startContainer).get(0)+" ("+a(aC.startContainer).get(0).tagName+")");ep.debug("(I) startOffset = "+aC.startOffset);ep.debug("(I) rangyRange.endContainer = "+a(aC.endContainer).get(0)+" ("+a(aC.endContainer).get(0).tagName+")");ep.debug("(I) endOffset = "+aC.endOffset);ay=f(l,aC.startContainer,aC.startOffset,"");ax=f(l,aC.endContainer,aC.endOffset,"");}if(ay&&ax){O([ay,ax]);}}function O(ax){ep.debug("ep.ebookViewer.epubIframe: emitCFIArray()!!");var ay={};ay.cfiArray=ax;ep.publish("epub:rangeSelected",ay);}function ai(ax){window.open(ax,"_blank");window.focus();}function aa(ay){var ax=a(ay).find("a");ax.each(function(aB,az){if(a(az).attr("href")){a.noop();}var aF=new RegExp("^[a-z][a-z,0-9,+,-,.]+://","i");var aG=new RegExp("^//");var aA=new RegExp("^#");var aE=new RegExp("^[a-z][a-z,0-9,+,-,.]+:","i");var aH=a(az).attr("href");if(aH){var aC=aH.match(aF)||aH.match(aG);var aD=aH.match(aE);if(aC){a(az).on("click",function(aI){aI.preventDefault();ai(aH);});}else{if(aD){a(az).on("click",function(aI){aI.preventDefault();});}else{if(aA.test(aH)){a.noop();}else{a(az).on("click",function(aI){aI.preventDefault();ep.debug('publishing "getDocument.epubViewer" url='+aH);ep.publish("getDocument.epubViewer",{theArtifactId:aH});});}}}}});}var N=a("body").attr("data-zoom");var M=100;if(N){M=parseInt(N,10);}var aw=(M>100)?"in":(M<100)?"out":"nil";setTimeout(function(){if("nil"!==aw){g(aw,l,M);}ep.publish("eBookViewer.documentZoomed");},1);function V(ax){var az=a(ax.body).children().text();var ay=true;az=az.replace(/^\s+/,"").replace(/\s+$/,"");if(az===""){ay=false;}return ay;}m=a("#ePubFrame").get(0);if(m){var P;l=m.contentDocument?m.contentDocument:document.frames.ePubFrame.document;P=V(l);rangy.init();R=rangy.dom.getIframeWindow(m);R.focus();a(l).on({mouseup:function(){if(P){L();}},dblclick:function(){if(P){L();}},click:function(ax){ao();ab(ax);},keydown:function(ax){ep.ebookViewer.epubIframe.keyDownHandler(ax);},copy:function(ax){if(T){ax.preventDefault();}else{ep.Viewer.Utilities.addCitationToSelection(R);}},contextmenu:function(ax){ax.preventDefault();}});var K=function(){window.location.href+="#";setTimeout(J(),50);};var J=function(){window.location.href+="1";};if(U){var ar=window.location.hash;window.setInterval(function(){if(window.location.hash!==ar){window.location.hash=ar;}},50);K();}if(T){a("head",l).append('<style type="text/css" media="print">.noprint { display:none }</style>');a("body",l).addClass("noprint");}aa(l);}ep.ebookViewer.epubIframe.keyDownHandler=function(ax){if(ax.keyCode===65){if(!ax.ctrlKey){return;}else{L();}}else{ep.debug("ep.ebookViewer.epubIframe.keyDownHandler(): event.keyCode =%d",ax.keyCode);}};function ao(){a("span.nada",l).each(function(ay,ax){a(ax).replaceWith(a(ax).html());});}function ab(aA){var ax=a(aA.target).closest("a[href]");if(!ax.length){return;}aA.preventDefault();var ay=a(ax.attr("href"),l);if(ay){var aB=ay.offset();var az=ay.css("display");if(az==="inline"){aB=ay.parent().offset();}m.contentWindow.scrollTo(aB.left,aB.top);}}if("never"!==H){var F=jQuery("body",l).attr("id");var Z=jQuery("body",l).attr("data-ep_lpid");H=(F==="Page-__-8"&&Z==="navPoint-2");}else{H=false;}if(H){var I=[{start:"/2/4[Page-__-8]/70/1:697",end:"/2/4[Page-__-8]/70/1:708"},{start:"/2/4[Page-__-8]/54[Page-__-10]/1:352",end:"/2/4[Page-__-8]/54[Page-__-10]/1:363"},{start:"/2/4[Page-__-8]/36/1:82",end:"/2/4[Page-__-8]/36/1:93"},{start:"/2/4[Page-__-8]/30/1:13",end:"/2/4[Page-__-8]/30/1:24"},{start:"/2/4[Page-__-8]/16/1:921",end:"/2/4[Page-__-8]/16/1:932"},{start:"/2/4[Page-__-8]/16/1:509",end:"/2/4[Page-__-8]/16/1:520"},{start:"/2/4[Page-__-8]/12/1:153",end:"/2/4[Page-__-8]/12/1:164"},{start:"/2/4[Page-__-8]/10/4/1:41",end:"/2/4[Page-__-8]/10/4/1:52"},{start:"/2/4[Page-__-8]/10/2/1:38",end:"/2/4[Page-__-8]/10/2/1:49"}];var ak,al;var ag,ah;var Y,ae;var au,at;var ap='<span class="nada" style="background-color:yellow">';var aq="</span>";var ad;var ac;if(false){I.sort(function(ax,ay){if(ax.start===ay.start){return 0;}else{if(ax.start<ay.start){return -1;}}return 1;});}R.focus();var Q=function(ax,ay){if((ay!==ak.theNode)&&(ay!==al.theNode)){au=ay.data;at=au.substr(0,au.length);ac=ap+at+aq;ad=au.replace(at,ac);a(ay).replaceWith(ad);}};for(var S=0;S<I.length;S++){var av;ak=x(l,I[S].start);al=x(l,I[S].end);ae=null;if((S+1)<I.length){ae=x(l,I[S+1].start);}ag=ak.theRange.startOffset;ah=al.theRange.startOffset;if(ak.node!==al.node){var am=rangy.createRange(l);am.setStart(ak.node,ak.theRange.startOffset);am.setEnd(al.node,al.theRange.startOffset);av=am.getNodes([3]);au=ak.node.data;at=au.substr(ag,au.length-ag);ac=ap+at+aq;ad=au.replace(at,ac);a(ak.node).parent().html(ad);if(av.length>2){a.each(av,Q(idx,nodes));}au=al.node.data;at=au.substr(0,ah+1);ac=ap+at+aq;ad=au.replace(at,ac);a(al.node).parent().html(ad);}else{if(Y===ak.node){a.noop();}else{au=ak.node.data;}at=au.substr(ag,ah-ag);ac=ap+at+aq;if(false){ad=au.replace(at,ac);}else{ad=au.substr(0,ag);ad+=ac;ad+=au.substr(ah);}if(ae&&(ak===ae)){a.noop();}else{a(ak.node).parent().html(ad);}Y=ak.node;}}if(false){a("span.nada",l).each(function(ay,ax){if(0===ay){ax.scrollIntoView();}});}if(G){setTimeout(function(){ao();},3000);}}});ep.require("jquery/plugins/jquery.ba-throttle-debounce.js",function(){ep.subscribe("epub:iframeready",function(){var F;F=jQuery("#ePubFrame").get(0);var G=F.contentWindow;a(G).scroll(a.debounce(500,function(){var H;H=ep.ebookViewer.ifrmPageWatcher.whereAreWe();a(document).trigger("documentScroll.epubViewer",H);}));});});function b(){ep.subscribe("toolsZoom.ebookViewer",D);}return{registerZoomFunc:b};})(jQuery));jQuery(document).ready(function(){ep.ebookViewer.epubIframe.registerZoomFunc();});window.rangy=function(){function s(c,f){var i=typeof c[f];return i=="function"||!!(i=="object"&&c[f])||i=="unknown";}function p(c,f){return !!(typeof c[f]=="object"&&c[f]);}function h(c,f){return typeof c[f]!="undefined";}function m(c){return function(i,k){for(var f=k.length;f--;){if(!c(i,k[f])){return false;}}return true;};}function M(c){return c&&b(c,J)&&G(c,F);}function e(c){window.alert("Rangy not supported in your browser. Reason: "+c);d.initialized=true;d.supported=false;}function y(){if(!d.initialized){var f,i=false,k=false;if(s(document,"createRange")){f=document.createRange();if(b(f,w)&&G(f,j)){i=true;}f.detach();}if((f=p(document,"body")?document.body:document.getElementsByTagName("body")[0])&&s(f,"createTextRange")){f=f.createTextRange();if(M(f)){k=true;}}!i&&!k&&e("Neither Range nor TextRange are implemented");d.initialized=true;d.features={implementsDomRange:i,implementsTextRange:k};i=o.concat(g);k=0;for(f=i.length;k<f;++k){try{i[k](d);}catch(c){p(window,"console")&&s(window.console,"log")&&window.console.log("Init listener threw an exception. Continuing.",c);}}}}function B(c){this.name=c;this.supported=this.initialized=false;}var j=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer","START_TO_START","START_TO_END","END_TO_START","END_TO_END"],w=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],F=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],J=["collapse","compareEndPoints","duplicate","getBookmark","moveToBookmark","moveToElementText","parentElement","pasteHTML","select","setEndPoint","getBoundingClientRect"],b=m(s),D=m(p),G=m(h),d={version:"1.2.3",initialized:false,supported:true,util:{isHostMethod:s,isHostObject:p,isHostProperty:h,areHostMethods:b,areHostObjects:D,areHostProperties:G,isTextRange:M},features:{},modules:{},config:{alertOnWarn:false,preferTextRange:false}};d.fail=e;d.warn=function(c){c="Rangy warning: "+c;if(d.config.alertOnWarn){window.alert(c);}else{typeof window.console!="undefined"&&typeof window.console.log!="undefined"&&window.console.log(c);}};if({}.hasOwnProperty){d.util.extend=function(c,f){for(var i in f){if(f.hasOwnProperty(i)){c[i]=f[i];}}};}else{e("hasOwnProperty not supported");}var g=[],o=[];d.init=y;d.addInitListener=function(c){d.initialized?c(d):g.push(c);};var E=[];d.addCreateMissingNativeApiListener=function(c){E.push(c);};d.createMissingNativeApi=function(c){c=c||window;y();for(var f=0,i=E.length;f<i;++f){E[f](c);}};B.prototype.fail=function(c){this.initialized=true;this.supported=false;throw Error("Module '"+this.name+"' failed to load: "+c);};B.prototype.warn=function(c){d.warn("Module "+this.name+": "+c);};B.prototype.createError=function(c){return Error("Error in Rangy "+this.name+" module: "+c);};d.createModule=function(c,f){var i=new B(c);d.modules[c]=i;o.push(function(k){f(k,i);i.initialized=true;i.supported=true;});};d.requireModules=function(f){for(var i=0,l=f.length,c,k;i<l;++i){k=f[i];c=d.modules[k];if(!c||!(c instanceof B)){throw Error("Module '"+k+"' not found");}if(!c.supported){throw Error("Module '"+k+"' not supported");}}};var u=false;D=function(){if(!u){u=true;d.initialized||y();}};if(typeof window=="undefined"){e("No window found");}else{if(typeof document=="undefined"){e("No document found");}else{s(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",D,false);if(s(window,"addEventListener")){window.addEventListener("load",D,false);}else{s(window,"attachEvent")?window.attachEvent("onload",D):e("Window does not have required addEventListener or attachEvent method");}return d;}}}();rangy.createModule("DomUtil",function(h,g){function d(i){for(var l=0;i=i.previousSibling;){l++;}return l;}function f(i,l){var n=[],q;for(q=i;q;q=q.parentNode){n.push(q);}for(q=l;q;q=q.parentNode){if(r(n,q)){return q;}}return null;}function u(i,l,n){for(n=n?i:i.parentNode;n;){i=n.parentNode;if(i===l){return n;}n=i;}return null;}function c(i){i=i.nodeType;return i==3||i==4||i==8;}function k(i,l){var n=l.nextSibling,q=l.parentNode;n?q.insertBefore(i,n):q.appendChild(i);return i;}function m(i){if(i.nodeType==9){return i;}else{if(typeof i.ownerDocument!="undefined"){return i.ownerDocument;}else{if(typeof i.document!="undefined"){return i.document;}else{if(i.parentNode){return m(i.parentNode);}else{throw Error("getDocument: no document found for node");}}}}}function e(i){if(!i){return"[No node]";}return c(i)?'"'+i.data+'"':i.nodeType==1?"<"+i.nodeName+(i.id?' id="'+i.id+'"':"")+">["+i.childNodes.length+"]":i.nodeName;}function j(i){this._next=this.root=i;}function p(i,l){this.node=i;this.offset=l;}function s(i){this.code=this[i];this.codeName=i;this.message="DOMException: "+this.codeName;}var b=h.util;b.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||g.fail("document missing a Node creation method");b.isHostMethod(document,"getElementsByTagName")||g.fail("document missing getElementsByTagName method");var o=document.createElement("div");b.areHostMethods(o,["insertBefore","appendChild","cloneNode"])||g.fail("Incomplete Element implementation");b.isHostProperty(o,"innerHTML")||g.fail("Element is missing innerHTML property");o=document.createTextNode("test");b.areHostMethods(o,["splitText","deleteData","insertData","appendData","cloneNode"])||g.fail("Incomplete Text Node implementation");var r=function(i,l){for(var n=i.length;n--;){if(i[n]===l){return true;}}return false;};j.prototype={_current:null,hasNext:function(){return !!this._next;},next:function(){var i=this._current=this._next,l;if(this._current){if(l=i.firstChild){this._next=l;}else{for(l=null;i!==this.root&&!(l=i.nextSibling);){i=i.parentNode;}this._next=l;}}return this._current;},detach:function(){this._current=this._next=this.root=null;}};p.prototype={equals:function(i){return this.node===i.node&this.offset==i.offset;},inspect:function(){return"[DomPosition("+e(this.node)+":"+this.offset+")]";}};s.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11};s.prototype.toString=function(){return this.message;};h.dom={arrayContains:r,isHtmlNamespace:function(i){var l;return typeof i.namespaceURI=="undefined"||(l=i.namespaceURI)===null||l=="http://www.w3.org/1999/xhtml";},parentElement:function(i){i=i.parentNode;return i.nodeType==1?i:null;},getNodeIndex:d,getNodeLength:function(i){var l;return c(i)?i.length:(l=i.childNodes)?l.length:0;},getCommonAncestor:f,isAncestorOf:function(i,l,n){for(l=n?l:l.parentNode;l;){if(l===i){return true;}else{l=l.parentNode;}}return false;},getClosestAncestorIn:u,isCharacterDataNode:c,insertAfter:k,splitDataNode:function(i,l){var n=i.cloneNode(false);n.deleteData(0,l);i.deleteData(l,i.length-l);k(n,i);return n;},getDocument:m,getWindow:function(i){i=m(i);if(typeof i.defaultView!="undefined"){return i.defaultView;}else{if(typeof i.parentWindow!="undefined"){return i.parentWindow;}else{throw Error("Cannot get a window object for node");}}},getIframeWindow:function(i){if(typeof i.contentWindow!="undefined"){return i.contentWindow;}else{if(typeof i.contentDocument!="undefined"){return i.contentDocument.defaultView;}else{throw Error("getIframeWindow: No Window object found for iframe element");}}},getIframeDocument:function(i){if(typeof i.contentDocument!="undefined"){return i.contentDocument;}else{if(typeof i.contentWindow!="undefined"){return i.contentWindow.document;}else{throw Error("getIframeWindow: No Document object found for iframe element");}}},getBody:function(i){return b.isHostObject(i,"body")?i.body:i.getElementsByTagName("body")[0];},getRootContainer:function(i){for(var l;l=i.parentNode;){i=l;}return i;},comparePoints:function(i,l,n,t){var q;if(i==n){return l===t?0:l<t?-1:1;}else{if(q=u(n,i,true)){return l<=d(q)?-1:1;}else{if(q=u(i,n,true)){return d(q)<t?-1:1;}else{l=f(i,n);i=i===l?l:u(i,l,true);n=n===l?l:u(n,l,true);if(i===n){throw Error("comparePoints got to case 4 and childA and childB are the same!");}else{for(l=l.firstChild;l;){if(l===i){return -1;}else{if(l===n){return 1;}}l=l.nextSibling;}throw Error("Should not be here!");}}}}},inspectNode:e,fragmentFromNodeChildren:function(i){for(var l=m(i).createDocumentFragment(),n;n=i.firstChild;){l.appendChild(n);}return l;},createIterator:function(i){return new j(i);},DomPosition:p};h.DOMException=s;});rangy.createModule("DomRange",function(aq){function ao(b,c){return b.nodeType!=3&&(ad.isAncestorOf(b,c.startContainer,true)||ad.isAncestorOf(b,c.endContainer,true));}function ag(b){return ad.getDocument(b.startContainer);}function aj(b,c,f){if(c=b._listeners[c]){for(var g=0,d=c.length;g<d;++g){c[g].call(b,{target:b,args:f});}}}function aS(b){return new aT(b.parentNode,ad.getNodeIndex(b));}function F(b){return new aT(b.parentNode,ad.getNodeIndex(b)+1);}function ax(b,c,d){var f=b.nodeType==11?b.firstChild:b;if(ad.isCharacterDataNode(c)){d==c.length?ad.insertAfter(b,c):c.parentNode.insertBefore(b,d==0?c:ad.splitDataNode(c,d));}else{d>=c.childNodes.length?c.appendChild(b):c.insertBefore(b,c.childNodes[d]);}return f;}function az(b){for(var c,d,f=ag(b.range).createDocumentFragment();d=b.next();){c=b.isPartiallySelectedSubtree();d=d.cloneNode(!c);if(c){c=b.getSubtreeIterator();d.appendChild(az(c));c.detach(true);}if(d.nodeType==10){throw new aH("HIERARCHY_REQUEST_ERR");}f.appendChild(d);}return f;}function ai(b,c,f){var g,d;for(f=f||{stop:false};g=b.next();){if(b.isPartiallySelectedSubtree()){if(c(g)===false){f.stop=true;return;}else{g=b.getSubtreeIterator();ai(g,c,f);g.detach(true);if(f.stop){return;}}}else{for(g=ad.createIterator(g);d=g.next();){if(c(d)===false){f.stop=true;return;}}}}}function aw(b){for(var c;b.next();){if(b.isPartiallySelectedSubtree()){c=b.getSubtreeIterator();aw(c);c.detach(true);}else{b.remove();}}}function aI(b){for(var c,d=ag(b.range).createDocumentFragment(),f;c=b.next();){if(b.isPartiallySelectedSubtree()){c=c.cloneNode(false);f=b.getSubtreeIterator();c.appendChild(aI(f));f.detach(true);}else{b.remove();}if(c.nodeType==10){throw new aH("HIERARCHY_REQUEST_ERR");}d.appendChild(c);}return d;}function aP(b,c,f){var h=!!(c&&c.length),d,i=!!f;if(h){d=RegExp("^("+c.join("|")+")$");}var g=[];ai(new aE(b,false),function(k){if((!h||d.test(k.nodeType))&&(!i||f(k))){g.push(k);}});return g;}function j(b){return"["+(typeof b.getName=="undefined"?"Range":b.getName())+"("+ad.inspectNode(b.startContainer)+":"+b.startOffset+", "+ad.inspectNode(b.endContainer)+":"+b.endOffset+")]";}function aE(b,c){this.range=b;this.clonePartiallySelectedTextNodes=c;if(!b.collapsed){this.sc=b.startContainer;this.so=b.startOffset;this.ec=b.endContainer;this.eo=b.endOffset;var d=b.commonAncestorContainer;if(this.sc===this.ec&&ad.isCharacterDataNode(this.sc)){this.isSingleCharacterDataNode=true;this._first=this._last=this._next=this.sc;}else{this._first=this._next=this.sc===d&&!ad.isCharacterDataNode(this.sc)?this.sc.childNodes[this.so]:ad.getClosestAncestorIn(this.sc,d,true);this._last=this.ec===d&&!ad.isCharacterDataNode(this.ec)?this.ec.childNodes[this.eo-1]:ad.getClosestAncestorIn(this.ec,d,true);}}}function aL(b){this.code=this[b];this.codeName=b;this.message="RangeException: "+this.codeName;}function E(b,c,d){this.nodes=aP(b,c,d);this._next=this.nodes[0];this._position=0;}function ab(b){return function(c,f){for(var g,d=f?c:c.parentNode;d;){g=d.nodeType;if(ad.arrayContains(b,g)){return d;}d=d.parentNode;}return null;};}function an(b,c){if(ae(b,c)){throw new aL("INVALID_NODE_TYPE_ERR");}}function aF(b){if(!b.startContainer){throw new aH("INVALID_STATE_ERR");}}function ar(b,c){if(!ad.arrayContains(c,b.nodeType)){throw new aL("INVALID_NODE_TYPE_ERR");}}function aB(b,c){if(c<0||c>(ad.isCharacterDataNode(b)?b.length:b.childNodes.length)){throw new aH("INDEX_SIZE_ERR");}}function aK(b,c){if(af(b,true)!==af(c,true)){throw new aH("WRONG_DOCUMENT_ERR");}}function aN(b){if(T(b,true)){throw new aH("NO_MODIFICATION_ALLOWED_ERR");}}function s(b,c){if(!b){throw new aH(c);}}function aM(b){return !!b.startContainer&&!!b.endContainer&&!(!ad.arrayContains(y,b.startContainer.nodeType)&&!af(b.startContainer,true))&&!(!ad.arrayContains(y,b.endContainer.nodeType)&&!af(b.endContainer,true))&&b.startOffset<=(ad.isCharacterDataNode(b.startContainer)?b.startContainer.length:b.startContainer.childNodes.length)&&b.endOffset<=(ad.isCharacterDataNode(b.endContainer)?b.endContainer.length:b.endContainer.childNodes.length);}function al(b){aF(b);if(!aM(b)){throw Error("Range error: Range is no longer valid after DOM mutation ("+b.inspect()+")");}}function Q(){}function aR(b){b.START_TO_START=ak;b.START_TO_END=at;b.END_TO_END=aG;b.END_TO_START=av;b.NODE_BEFORE=ay;b.NODE_AFTER=aA;b.NODE_BEFORE_AND_AFTER=aD;b.NODE_INSIDE=am;}function aO(b){aR(b);aR(b.prototype);}function U(b,c){return function(){al(this);var f=this.startContainer,g=this.startOffset,d=this.commonAncestorContainer,h=new aE(this,true);if(f!==d){f=ad.getClosestAncestorIn(f,d,true);g=F(f);f=g.node;g=g.offset;}ai(h,aN);h.reset();d=b(h);h.detach();c(this,f,g,f,g);return d;};}function ac(b,c,f){function g(i,k){return function(l){aF(this);ar(l,e);ar(R(l),y);l=(i?aS:F)(l);(k?d:h)(this,l.node,l.offset);};}function d(k,n,p){var i=k.endContainer,l=k.endOffset;if(n!==k.startContainer||p!==k.startOffset){if(R(n)!=R(i)||ad.comparePoints(n,p,i,l)==1){i=n;l=p;}c(k,n,p,i,l);}}function h(k,n,p){var i=k.startContainer,l=k.startOffset;if(n!==k.endContainer||p!==k.endOffset){if(R(n)!=R(i)||ad.comparePoints(n,p,i,l)==-1){i=n;l=p;}c(k,i,l,n,p);}}b.prototype=new Q;aq.util.extend(b.prototype,{setStart:function(i,k){aF(this);an(i,true);aB(i,k);d(this,i,k);},setEnd:function(i,k){aF(this);an(i,true);aB(i,k);h(this,i,k);},setStartBefore:g(true,true),setStartAfter:g(false,true),setEndBefore:g(true,false),setEndAfter:g(false,false),collapse:function(i){al(this);i?c(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):c(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset);},selectNodeContents:function(i){aF(this);an(i,true);c(this,i,0,i,ad.getNodeLength(i));},selectNode:function(i){aF(this);an(i,false);ar(i,e);var k=aS(i);i=F(i);c(this,k.node,k.offset,i.node,i.offset);},extractContents:U(aI,c),deleteContents:U(aw,c),canSurroundContents:function(){al(this);aN(this.startContainer);aN(this.endContainer);var i=new aE(this,true),k=i._first&&ao(i._first,this)||i._last&&ao(i._last,this);i.detach();return !k;},detach:function(){f(this);},splitBoundaries:function(){al(this);var k=this.startContainer,n=this.startOffset,p=this.endContainer,i=this.endOffset,l=k===p;ad.isCharacterDataNode(p)&&i>0&&i<p.length&&ad.splitDataNode(p,i);if(ad.isCharacterDataNode(k)&&n>0&&n<k.length){k=ad.splitDataNode(k,n);if(l){i-=n;p=k;}else{p==k.parentNode&&i>=ad.getNodeIndex(k)&&i++;}n=0;}c(this,k,n,p,i);},normalizeBoundaries:function(){al(this);var l=this.startContainer,q=this.startOffset,r=this.endContainer,i=this.endOffset,n=function(u){var t=u.nextSibling;if(t&&t.nodeType==u.nodeType){r=u;i=u.length;u.appendData(t.data);t.parentNode.removeChild(t);}},p=function(v){var t=v.previousSibling;if(t&&t.nodeType==v.nodeType){l=v;var u=v.length;q=t.length;v.insertData(0,t.data);t.parentNode.removeChild(t);if(l==r){i+=q;r=l;}else{if(r==v.parentNode){t=ad.getNodeIndex(v);if(i==t){r=v;i=u;}else{i>t&&i--;}}}}},k=true;if(ad.isCharacterDataNode(r)){r.length==i&&n(r);}else{if(i>0){(k=r.childNodes[i-1])&&ad.isCharacterDataNode(k)&&n(k);}k=!this.collapsed;}if(k){if(ad.isCharacterDataNode(l)){q==0&&p(l);}else{if(q<l.childNodes.length){(n=l.childNodes[q])&&ad.isCharacterDataNode(n)&&p(n);}}}else{l=r;q=i;}c(this,l,q,r,i);},collapseToPoint:function(i,k){aF(this);an(i,true);aB(i,k);if(i!==this.startContainer||k!==this.startOffset||i!==this.endContainer||k!==this.endOffset){c(this,i,k,i,k);}}});aO(b);}function aa(b){b.collapsed=b.startContainer===b.endContainer&&b.startOffset===b.endOffset;b.commonAncestorContainer=b.collapsed?b.startContainer:ad.getCommonAncestor(b.startContainer,b.endContainer);}function ah(b,c,f,h,d){var i=b.startContainer!==c||b.startOffset!==f,g=b.endContainer!==h||b.endOffset!==d;b.startContainer=c;b.startOffset=f;b.endContainer=h;b.endOffset=d;aa(b);aj(b,"boundarychange",{startMoved:i,endMoved:g});}function au(b){this.startContainer=b;this.startOffset=0;this.endContainer=b;this.endOffset=0;this._listeners={boundarychange:[],detach:[]};aa(this);}aq.requireModules(["DomUtil"]);var ad=aq.dom,aT=ad.DomPosition,aH=aq.DOMException;aE.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:false,reset:function(){this._current=null;this._next=this._first;},hasNext:function(){return !!this._next;},next:function(){var b=this._current=this._next;if(b){this._next=b!==this._last?b.nextSibling:null;if(ad.isCharacterDataNode(b)&&this.clonePartiallySelectedTextNodes){if(b===this.ec){(b=b.cloneNode(true)).deleteData(this.eo,b.length-this.eo);}if(this._current===this.sc){(b=b.cloneNode(true)).deleteData(0,this.so);}}}return b;},remove:function(){var b=this._current,c,d;if(ad.isCharacterDataNode(b)&&(b===this.sc||b===this.ec)){c=b===this.sc?this.so:0;d=b===this.ec?this.eo:b.length;c!=d&&b.deleteData(c,d-c);}else{b.parentNode&&b.parentNode.removeChild(b);}},isPartiallySelectedSubtree:function(){return ao(this._current,this.range);},getSubtreeIterator:function(){var b;if(this.isSingleCharacterDataNode){b=this.range.cloneRange();b.collapse();}else{b=new au(ag(this.range));var c=this._current,f=c,g=0,d=c,h=ad.getNodeLength(c);if(ad.isAncestorOf(c,this.sc,true)){f=this.sc;g=this.so;}if(ad.isAncestorOf(c,this.ec,true)){d=this.ec;h=this.eo;}ah(b,f,g,d,h);}return new aE(b,this.clonePartiallySelectedTextNodes);},detach:function(b){b&&this.range.detach();this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null;}};aL.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2};aL.prototype.toString=function(){return this.message;};E.prototype={_current:null,hasNext:function(){return !!this._next;},next:function(){this._current=this._next;this._next=this.nodes[++this._position];return this._current;},detach:function(){this._current=this._next=this.nodes=null;}};var e=[1,3,4,5,7,8,10],y=[2,9,11],m=[1,3,4,5,7,8,10,11],o=[1,3,4,5,7,8],R=ad.getRootContainer,af=ab([9,11]),T=ab([5,6,10,12]),ae=ab([6,10,12]),aC=document.createElement("style"),aQ=false;try{aC.innerHTML="<b>x</b>";aQ=aC.firstChild.nodeType==3;}catch(aJ){}aq.features.htmlParsingConforms=aQ;var ap=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],ak=0,at=1,aG=2,av=3,ay=0,aA=1,aD=2,am=3;Q.prototype={attachListener:function(b,c){this._listeners[b].push(c);},compareBoundaryPoints:function(b,c){al(this);aK(this.startContainer,c.startContainer);var d=b==av||b==ak?"start":"end",f=b==at||b==ak?"start":"end";return ad.comparePoints(this[d+"Container"],this[d+"Offset"],c[f+"Container"],c[f+"Offset"]);},insertNode:function(b){al(this);ar(b,m);aN(this.startContainer);if(ad.isAncestorOf(b,this.startContainer,true)){throw new aH("HIERARCHY_REQUEST_ERR");}this.setStartBefore(ax(b,this.startContainer,this.startOffset));},cloneContents:function(){al(this);var b,c;if(this.collapsed){return ag(this).createDocumentFragment();}else{if(this.startContainer===this.endContainer&&ad.isCharacterDataNode(this.startContainer)){b=this.startContainer.cloneNode(true);b.data=b.data.slice(this.startOffset,this.endOffset);c=ag(this).createDocumentFragment();c.appendChild(b);return c;}else{c=new aE(this,true);b=az(c);c.detach();}return b;}},canSurroundContents:function(){al(this);aN(this.startContainer);aN(this.endContainer);var b=new aE(this,true),c=b._first&&ao(b._first,this)||b._last&&ao(b._last,this);b.detach();return !c;},surroundContents:function(b){ar(b,o);if(!this.canSurroundContents()){throw new aL("BAD_BOUNDARYPOINTS_ERR");}var c=this.extractContents();if(b.hasChildNodes()){for(;b.lastChild;){b.removeChild(b.lastChild);}}ax(b,this.startContainer,this.startOffset);b.appendChild(c);this.selectNode(b);},cloneRange:function(){al(this);for(var b=new au(ag(this)),c=ap.length,d;c--;){d=ap[c];b[d]=this[d];}return b;},toString:function(){al(this);var b=this.startContainer;if(b===this.endContainer&&ad.isCharacterDataNode(b)){return b.nodeType==3||b.nodeType==4?b.data.slice(this.startOffset,this.endOffset):"";}else{var c=[];b=new aE(this,true);ai(b,function(d){if(d.nodeType==3||d.nodeType==4){c.push(d.data);}});b.detach();return c.join("");}},compareNode:function(b){al(this);var c=b.parentNode,d=ad.getNodeIndex(b);if(!c){throw new aH("NOT_FOUND_ERR");}b=this.comparePoint(c,d);c=this.comparePoint(c,d+1);return b<0?c>0?aD:ay:c>0?aA:am;},comparePoint:function(b,c){al(this);s(b,"HIERARCHY_REQUEST_ERR");aK(b,this.startContainer);if(ad.comparePoints(b,c,this.startContainer,this.startOffset)<0){return -1;}else{if(ad.comparePoints(b,c,this.endContainer,this.endOffset)>0){return 1;}}return 0;},createContextualFragment:aQ?function(b){var c=this.startContainer,d=ad.getDocument(c);if(!c){throw new aH("INVALID_STATE_ERR");}var f=null;if(c.nodeType==1){f=c;}else{if(ad.isCharacterDataNode(c)){f=ad.parentElement(c);}}f=f===null||f.nodeName=="HTML"&&ad.isHtmlNamespace(ad.getDocument(f).documentElement)&&ad.isHtmlNamespace(f)?d.createElement("body"):f.cloneNode(false);f.innerHTML=b;return ad.fragmentFromNodeChildren(f);}:function(b){aF(this);var c=ag(this).createElement("body");c.innerHTML=b;return ad.fragmentFromNodeChildren(c);},toHtml:function(){al(this);var b=ag(this).createElement("div");b.appendChild(this.cloneContents());return b.innerHTML;},intersectsNode:function(b,c){al(this);s(b,"NOT_FOUND_ERR");if(ad.getDocument(b)!==ag(this)){return false;}var f=b.parentNode,g=ad.getNodeIndex(b);s(f,"NOT_FOUND_ERR");var d=ad.comparePoints(f,g,this.endContainer,this.endOffset);f=ad.comparePoints(f,g+1,this.startContainer,this.startOffset);return c?d<=0&&f>=0:d<0&&f>0;},isPointInRange:function(b,c){al(this);s(b,"HIERARCHY_REQUEST_ERR");aK(b,this.startContainer);return ad.comparePoints(b,c,this.startContainer,this.startOffset)>=0&&ad.comparePoints(b,c,this.endContainer,this.endOffset)<=0;},intersectsRange:function(b,c){al(this);if(ag(b)!=ag(this)){throw new aH("WRONG_DOCUMENT_ERR");}var d=ad.comparePoints(this.startContainer,this.startOffset,b.endContainer,b.endOffset),f=ad.comparePoints(this.endContainer,this.endOffset,b.startContainer,b.startOffset);return c?d<=0&&f>=0:d<0&&f>0;},intersection:function(b){if(this.intersectsRange(b)){var c=ad.comparePoints(this.startContainer,this.startOffset,b.startContainer,b.startOffset),d=ad.comparePoints(this.endContainer,this.endOffset,b.endContainer,b.endOffset),f=this.cloneRange();c==-1&&f.setStart(b.startContainer,b.startOffset);d==1&&f.setEnd(b.endContainer,b.endOffset);return f;}return null;},union:function(b){if(this.intersectsRange(b,true)){var c=this.cloneRange();ad.comparePoints(b.startContainer,b.startOffset,this.startContainer,this.startOffset)==-1&&c.setStart(b.startContainer,b.startOffset);ad.comparePoints(b.endContainer,b.endOffset,this.endContainer,this.endOffset)==1&&c.setEnd(b.endContainer,b.endOffset);return c;}else{throw new aL("Ranges do not intersect");}},containsNode:function(b,c){return c?this.intersectsNode(b,false):this.compareNode(b)==am;},containsNodeContents:function(b){return this.comparePoint(b,0)>=0&&this.comparePoint(b,ad.getNodeLength(b))<=0;},containsRange:function(b){return this.intersection(b).equals(b);},containsNodeText:function(b){var c=this.cloneRange();c.selectNode(b);var d=c.getNodes([3]);if(d.length>0){c.setStart(d[0],0);b=d.pop();c.setEnd(b,b.length);b=this.containsRange(c);c.detach();return b;}else{return this.containsNodeContents(b);}},createNodeIterator:function(b,c){al(this);return new E(this,b,c);},getNodes:function(b,c){al(this);return aP(this,b,c);},getDocument:function(){return ag(this);},collapseBefore:function(b){aF(this);this.setEndBefore(b);this.collapse(false);},collapseAfter:function(b){aF(this);this.setStartAfter(b);this.collapse(true);},getName:function(){return"DomRange";},equals:function(b){return au.rangesEqual(this,b);},isValid:function(){return aM(this);},inspect:function(){return j(this);}};ac(au,ah,function(b){aF(b);b.startContainer=b.startOffset=b.endContainer=b.endOffset=null;b.collapsed=b.commonAncestorContainer=null;aj(b,"detach",null);b._listeners=null;});aq.rangePrototype=Q.prototype;au.rangeProperties=ap;au.RangeIterator=aE;au.copyComparisonConstants=aO;au.createPrototypeRange=ac;au.inspect=j;au.getRangeDocument=ag;au.rangesEqual=function(b,c){return b.startContainer===c.startContainer&&b.startOffset===c.startOffset&&b.endContainer===c.endContainer&&b.endOffset===c.endOffset;};aq.DomRange=au;aq.RangeException=aL;});rangy.createModule("WrappedRange",function(f){function e(l,m,p,s){var j=l.duplicate();j.collapse(p);var o=j.parentElement();i.isAncestorOf(m,o,true)||(o=m);if(!o.canHaveHTML){return new b(o.parentNode,i.getNodeIndex(o));}m=i.getDocument(o).createElement("span");var r,k=p?"StartToStart":"StartToEnd";do{o.insertBefore(m,m.previousSibling);j.moveToElementText(m);}while((r=j.compareEndPoints(k,l))>0&&m.previousSibling);k=m.nextSibling;if(r==-1&&k&&i.isCharacterDataNode(k)){j.setEndPoint(p?"EndToStart":"EndToEnd",l);if(/[\r\n]/.test(k.data)){o=j.duplicate();p=o.text.replace(/\r\n/g,"\r").length;for(p=o.moveStart("character",p);o.compareEndPoints("StartToEnd",o)==-1;){p++;o.moveStart("character",1);}}else{p=j.text.length;}o=new b(k,p);}else{k=(s||!p)&&m.previousSibling;o=(p=(s||p)&&m.nextSibling)&&i.isCharacterDataNode(p)?new b(p,0):k&&i.isCharacterDataNode(k)?new b(k,k.length):new b(o,i.getNodeIndex(m));}m.parentNode.removeChild(m);return o;}function c(l,m){var p,s,j=l.offset,o=i.getDocument(l.node),r=o.body.createTextRange(),k=i.isCharacterDataNode(l.node);if(k){p=l.node;s=p.parentNode;}else{p=l.node.childNodes;p=j<p.length?p[j]:null;s=l.node;}o=o.createElement("span");o.innerHTML="&#feff;";p?s.insertBefore(o,p):s.appendChild(o);r.moveToElementText(o);r.collapse(!m);s.removeChild(o);if(k){r[m?"moveStart":"moveEnd"]("character",j);}return r;}f.requireModules(["DomUtil","DomRange"]);var d,i=f.dom,b=i.DomPosition,g=f.DomRange;if(f.features.implementsDomRange&&(!f.features.implementsTextRange||!f.config.preferTextRange)){(function(){function l(n){for(var q=p.length,t;q--;){t=p[q];n[t]=n.nativeRange[t];}}var m,p=g.rangeProperties,s,j;d=function(n){if(!n){throw Error("Range must be specified");}this.nativeRange=n;l(this);};g.createPrototypeRange(d,function(n,q,w,t,v){var x=n.endContainer!==t||n.endOffset!=v;if(n.startContainer!==q||n.startOffset!=w||x){n.setEnd(t,v);n.setStart(q,w);}},function(n){n.nativeRange.detach();n.detached=true;for(var q=p.length,t;q--;){t=p[q];n[t]=null;}});m=d.prototype;m.selectNode=function(n){this.nativeRange.selectNode(n);l(this);};m.deleteContents=function(){this.nativeRange.deleteContents();l(this);};m.extractContents=function(){var n=this.nativeRange.extractContents();l(this);return n;};m.cloneContents=function(){return this.nativeRange.cloneContents();};m.surroundContents=function(n){this.nativeRange.surroundContents(n);l(this);};m.collapse=function(n){this.nativeRange.collapse(n);l(this);};m.cloneRange=function(){return new d(this.nativeRange.cloneRange());};m.refresh=function(){l(this);};m.toString=function(){return this.nativeRange.toString();};var o=document.createTextNode("test");i.getBody(document).appendChild(o);var r=document.createRange();r.setStart(o,0);r.setEnd(o,0);try{r.setStart(o,1);s=true;m.setStart=function(n,q){this.nativeRange.setStart(n,q);l(this);};m.setEnd=function(n,q){this.nativeRange.setEnd(n,q);l(this);};j=function(n){return function(q){this.nativeRange[n](q);l(this);};};}catch(k){s=false;m.setStart=function(n,q){try{this.nativeRange.setStart(n,q);}catch(t){this.nativeRange.setEnd(n,q);this.nativeRange.setStart(n,q);}l(this);};m.setEnd=function(n,q){try{this.nativeRange.setEnd(n,q);}catch(t){this.nativeRange.setStart(n,q);this.nativeRange.setEnd(n,q);}l(this);};j=function(n,q){return function(u){try{this.nativeRange[n](u);}catch(t){this.nativeRange[q](u);this.nativeRange[n](u);}l(this);};};}m.setStartBefore=j("setStartBefore","setEndBefore");m.setStartAfter=j("setStartAfter","setEndAfter");m.setEndBefore=j("setEndBefore","setStartBefore");m.setEndAfter=j("setEndAfter","setStartAfter");r.selectNodeContents(o);m.selectNodeContents=r.startContainer==o&&r.endContainer==o&&r.startOffset==0&&r.endOffset==o.length?function(n){this.nativeRange.selectNodeContents(n);l(this);}:function(n){this.setStart(n,0);this.setEnd(n,g.getEndOffset(n));};r.selectNodeContents(o);r.setEnd(o,3);s=document.createRange();s.selectNodeContents(o);s.setEnd(o,4);s.setStart(o,2);m.compareBoundaryPoints=r.compareBoundaryPoints(r.START_TO_END,s)==-1&r.compareBoundaryPoints(r.END_TO_START,s)==1?function(n,q){q=q.nativeRange||q;if(n==q.START_TO_END){n=q.END_TO_START;}else{if(n==q.END_TO_START){n=q.START_TO_END;}}return this.nativeRange.compareBoundaryPoints(n,q);}:function(n,q){return this.nativeRange.compareBoundaryPoints(n,q.nativeRange||q);};if(f.util.isHostMethod(r,"createContextualFragment")){m.createContextualFragment=function(n){return this.nativeRange.createContextualFragment(n);};}i.getBody(document).removeChild(o);r.detach();s.detach();})();f.createNativeRange=function(j){j=j||document;return j.createRange();};}else{if(f.features.implementsTextRange){d=function(j){this.textRange=j;this.refresh();};d.prototype=new g(document);d.prototype.refresh=function(){var j,k,l=this.textRange;j=l.parentElement();var m=l.duplicate();m.collapse(true);k=m.parentElement();m=l.duplicate();m.collapse(false);l=m.parentElement();k=k==l?k:i.getCommonAncestor(k,l);k=k==j?k:i.getCommonAncestor(j,k);if(this.textRange.compareEndPoints("StartToEnd",this.textRange)==0){k=j=e(this.textRange,k,true,true);}else{j=e(this.textRange,k,true,false);k=e(this.textRange,k,false,false);}this.setStart(j.node,j.offset);this.setEnd(k.node,k.offset);};g.copyComparisonConstants(d);var h=function(){return this;}();if(typeof h.Range=="undefined"){h.Range=d;}f.createNativeRange=function(j){j=j||document;return j.body.createTextRange();};}}if(f.features.implementsTextRange){d.rangeToTextRange=function(j){if(j.collapsed){return c(new b(j.startContainer,j.startOffset),true);}else{var k=c(new b(j.startContainer,j.startOffset),true),l=c(new b(j.endContainer,j.endOffset),false);j=i.getDocument(j.startContainer).body.createTextRange();j.setEndPoint("StartToStart",k);j.setEndPoint("EndToEnd",l);return j;}};}d.prototype.getName=function(){return"WrappedRange";};f.WrappedRange=d;f.createRange=function(j){j=j||document;return new d(f.createNativeRange(j));};f.createRangyRange=function(j){j=j||document;return new g(j);};f.createIframeRange=function(j){return f.createRange(i.getIframeDocument(j));};f.createIframeRangyRange=function(j){return f.createRangyRange(i.getIframeDocument(j));};f.addCreateMissingNativeApiListener(function(j){j=j.document;if(typeof j.createRange=="undefined"){j.createRange=function(){return f.createRange(this);};}j=j=null;});});rangy.createModule("WrappedSelection",function(ab,aa){function P(c){return(c||window).getSelection();}function T(c){return(c||window).document.selection;}function au(c,f,i){var g=i?"end":"start";i=i?"start":"end";c.anchorNode=f[g+"Container"];c.anchorOffset=f[g+"Offset"];c.focusNode=f[i+"Container"];c.focusOffset=f[i+"Offset"];}function o(c){c.anchorNode=c.focusNode=null;c.anchorOffset=c.focusOffset=0;c.rangeCount=0;c.isCollapsed=true;c._ranges.length=0;}function af(c){var f;if(c instanceof X){f=c._selectionNativeRange;if(!f){f=ab.createNativeRange(m.getDocument(c.startContainer));f.setEnd(c.endContainer,c.endOffset);f.setStart(c.startContainer,c.startOffset);c._selectionNativeRange=f;c.attachListener("detach",function(){this._selectionNativeRange=null;});}}else{if(c instanceof aj){f=c.nativeRange;}else{if(ab.features.implementsDomRange&&c instanceof m.getWindow(c.startContainer).Range){f=c;}}}return f;}function ag(c){var f=c.getNodes(),i;a:if(!f.length||f[0].nodeType!=1){i=false;}else{i=1;for(var g=f.length;i<g;++i){if(!m.isAncestorOf(f[0],f[i])){i=false;break a;}}i=true;}if(!i){throw Error("getSingleElementFromRange: range "+c.inspect()+" did not consist of a single element");}return f[0];}function R(c,f){var g=new aj(f);c._ranges=[g];au(c,g,false);c.rangeCount=1;c.isCollapsed=g.collapsed;}function ae(c){c._ranges.length=0;if(c.docSelection.type=="None"){o(c);}else{var f=c.docSelection.createRange();if(f&&typeof f.text!="undefined"){R(c,f);}else{c.rangeCount=f.length;for(var k,g=m.getDocument(f.item(0)),i=0;i<c.rangeCount;++i){k=ab.createRange(g);k.selectNode(f.item(i));c._ranges.push(k);}c.isCollapsed=c.rangeCount==1&&c._ranges[0].collapsed;au(c,c._ranges[c.rangeCount-1],false);}}}function al(c,f){var k=c.docSelection.createRange(),g=ag(f),i=m.getDocument(k.item(0));i=m.getBody(i).createControlRange();for(var l=0,p=k.length;l<p;++l){i.add(k.item(l));}try{i.add(g);}catch(n){throw Error("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)");}i.select();ae(c);}function ar(c,f,g){this.nativeSelection=c;this.docSelection=f;this._ranges=[];this.win=g;this.refresh();}function d(c,f){var k=m.getDocument(f[0].startContainer);k=m.getBody(k).createControlRange();for(var g=0,i;g<rangeCount;++g){i=ag(f[g]);try{k.add(i);}catch(l){throw Error("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)");}}k.select();ae(c);}function ai(c,f){if(c.anchorNode&&m.getDocument(c.anchorNode)!==m.getDocument(f)){throw new ac("WRONG_DOCUMENT_ERR");}}function an(c){var f=[],k=new ah(c.anchorNode,c.anchorOffset),g=new ah(c.focusNode,c.focusOffset),i=typeof c.getName=="function"?c.getName():"Selection";if(typeof c.rangeCount!="undefined"){for(var l=0,n=c.rangeCount;l<n;++l){f[l]=X.inspect(c.getRangeAt(l));}}return"["+i+"(Ranges: "+f.join(", ")+")(anchor: "+k.inspect()+", focus: "+g.inspect()+"]";}ab.requireModules(["DomUtil","DomRange","WrappedRange"]);ab.config.checkSelectionRanges=true;var m=ab.dom,E=ab.util,X=ab.DomRange,aj=ab.WrappedRange,ac=ab.DOMException,ah=m.DomPosition,am,ap,h=ab.util.isHostMethod(window,"getSelection"),ao=ab.util.isHostObject(document,"selection"),U=ao&&(!h||ab.config.preferTextRange);if(U){am=T;ab.isSelectionValid=function(c){c=(c||window).document;var f=c.selection;return f.type!="None"||m.getDocument(f.createRange().parentElement())==c;};}else{if(h){am=P;ab.isSelectionValid=function(){return true;};}else{aa.fail("Neither document.selection or window.getSelection() detected.");}}ab.getNativeSelection=am;h=am();var s=ab.createNativeRange(document),at=m.getBody(document),aq=E.areHostObjects(h,E.areHostProperties(h,["anchorOffset","focusOffset"]));ab.features.selectionHasAnchorAndFocus=aq;var y=E.isHostMethod(h,"extend");ab.features.selectionHasExtend=y;var F=typeof h.rangeCount=="number";ab.features.selectionHasRangeCount=F;var D=false,Q=true;E.areHostMethods(h,["addRange","getRangeAt","removeAllRanges"])&&typeof h.rangeCount=="number"&&ab.features.implementsDomRange&&function(){var c=document.createElement("iframe");c.frameBorder=0;c.style.position="absolute";c.style.left="-10000px";at.appendChild(c);var f=m.getIframeDocument(c);f.open();f.write("<html><head></head><body>12</body></html>");f.close();var k=m.getIframeWindow(c).getSelection(),g=f.documentElement.lastChild.firstChild;f=f.createRange();f.setStart(g,1);f.collapse(true);k.addRange(f);Q=k.rangeCount==1;k.removeAllRanges();var i=f.cloneRange();f.setStart(g,0);i.setEnd(g,2);k.addRange(f);k.addRange(i);D=k.rangeCount==2;f.detach();i.detach();at.removeChild(c);}();ab.features.selectionSupportsMultipleRanges=D;ab.features.collapsedNonEditableSelectionsSupported=Q;var ad=false,G;if(at&&E.isHostMethod(at,"createControlRange")){G=at.createControlRange();if(E.areHostProperties(G,["item","add"])){ad=true;}}ab.features.implementsControlRange=ad;ap=aq?function(c){return c.anchorNode===c.focusNode&&c.anchorOffset===c.focusOffset;}:function(c){return c.rangeCount?c.getRangeAt(c.rangeCount-1).collapsed:false;};var av;if(E.isHostMethod(h,"getRangeAt")){av=function(c,f){try{return c.getRangeAt(f);}catch(g){return null;}};}else{if(aq){av=function(c){var f=m.getDocument(c.anchorNode);f=ab.createRange(f);f.setStart(c.anchorNode,c.anchorOffset);f.setEnd(c.focusNode,c.focusOffset);if(f.collapsed!==this.isCollapsed){f.setStart(c.focusNode,c.focusOffset);f.setEnd(c.anchorNode,c.anchorOffset);}return f;};}}ab.getSelection=function(c){c=c||window;var f=c._rangySelection,i=am(c),g=ao?T(c):null;if(f){f.nativeSelection=i;f.docSelection=g;f.refresh(c);}else{f=new ar(i,g,c);c._rangySelection=f;}return f;};ab.getIframeSelection=function(c){return ab.getSelection(m.getIframeWindow(c));};G=ar.prototype;if(!U&&aq&&E.areHostMethods(h,["removeAllRanges","addRange"])){G.removeAllRanges=function(){this.nativeSelection.removeAllRanges();o(this);};var ak=function(c,f){var g=X.getRangeDocument(f);g=ab.createRange(g);g.collapseToPoint(f.endContainer,f.endOffset);c.nativeSelection.addRange(af(g));c.nativeSelection.extend(f.startContainer,f.startOffset);c.refresh();};G.addRange=F?function(c,f){if(ad&&ao&&this.docSelection.type=="Control"){al(this,c);}else{if(f&&y){ak(this,c);}else{var g;if(D){g=this.rangeCount;}else{this.removeAllRanges();g=0;}this.nativeSelection.addRange(af(c));this.rangeCount=this.nativeSelection.rangeCount;if(this.rangeCount==g+1){if(ab.config.checkSelectionRanges){if((g=av(this.nativeSelection,this.rangeCount-1))&&!X.rangesEqual(g,c)){c=new aj(g);}}this._ranges[this.rangeCount-1]=c;au(this,c,e(this.nativeSelection));this.isCollapsed=ap(this);}else{this.refresh();}}}}:function(c,f){if(f&&y){ak(this,c);}else{this.nativeSelection.addRange(af(c));this.refresh();}};G.setRanges=function(c){if(ad&&c.length>1){d(this,c);}else{this.removeAllRanges();for(var f=0,g=c.length;f<g;++f){this.addRange(c[f]);}}};}else{if(E.isHostMethod(h,"empty")&&E.isHostMethod(s,"select")&&ad&&U){G.removeAllRanges=function(){try{this.docSelection.empty();if(this.docSelection.type!="None"){var c;if(this.anchorNode){c=m.getDocument(this.anchorNode);}else{if(this.docSelection.type=="Control"){var f=this.docSelection.createRange();if(f.length){c=m.getDocument(f.item(0)).body.createTextRange();}}}if(c){c.body.createTextRange().select();this.docSelection.empty();}}}catch(g){}o(this);};G.addRange=function(c){if(this.docSelection.type=="Control"){al(this,c);}else{aj.rangeToTextRange(c).select();this._ranges[0]=c;this.rangeCount=1;this.isCollapsed=this._ranges[0].collapsed;au(this,c,false);}};G.setRanges=function(c){this.removeAllRanges();var f=c.length;if(f>1){d(this,c);}else{f&&this.addRange(c[0]);}};}else{aa.fail("No means of selecting a Range or TextRange was found");return false;}}G.getRangeAt=function(c){if(c<0||c>=this.rangeCount){throw new ac("INDEX_SIZE_ERR");}else{return this._ranges[c];}};var b;if(U){b=function(c){var f;if(ab.isSelectionValid(c.win)){f=c.docSelection.createRange();}else{f=m.getBody(c.win.document).createTextRange();f.collapse(true);}if(c.docSelection.type=="Control"){ae(c);}else{f&&typeof f.text!="undefined"?R(c,f):o(c);}};}else{if(E.isHostMethod(h,"getRangeAt")&&typeof h.rangeCount=="number"){b=function(c){if(ad&&ao&&c.docSelection.type=="Control"){ae(c);}else{c._ranges.length=c.rangeCount=c.nativeSelection.rangeCount;if(c.rangeCount){for(var f=0,g=c.rangeCount;f<g;++f){c._ranges[f]=new ab.WrappedRange(c.nativeSelection.getRangeAt(f));}au(c,c._ranges[c.rangeCount-1],e(c.nativeSelection));c.isCollapsed=ap(c);}else{o(c);}}};}else{if(aq&&typeof h.isCollapsed=="boolean"&&typeof s.collapsed=="boolean"&&ab.features.implementsDomRange){b=function(c){var f;f=c.nativeSelection;if(f.anchorNode){f=av(f,0);c._ranges=[f];c.rangeCount=1;f=c.nativeSelection;c.anchorNode=f.anchorNode;c.anchorOffset=f.anchorOffset;c.focusNode=f.focusNode;c.focusOffset=f.focusOffset;c.isCollapsed=ap(c);}else{o(c);}};}else{aa.fail("No means of obtaining a Range or TextRange from the user's selection was found");return false;}}}G.refresh=function(c){var f=c?this._ranges.slice(0):null;b(this);if(c){c=f.length;if(c!=this._ranges.length){return false;}for(;c--;){if(!X.rangesEqual(f[c],this._ranges[c])){return false;}}return true;}};var j=function(c,f){var k=c.getAllRanges(),g=false;c.removeAllRanges();for(var i=0,l=k.length;i<l;++i){if(g||f!==k[i]){c.addRange(k[i]);}else{g=true;}}c.rangeCount||o(c);};G.removeRange=ad?function(c){if(this.docSelection.type=="Control"){var f=this.docSelection.createRange();c=ag(c);var k=m.getDocument(f.item(0));k=m.getBody(k).createControlRange();for(var g,i=false,l=0,n=f.length;l<n;++l){g=f.item(l);if(g!==c||i){k.add(f.item(l));}else{i=true;}}k.select();ae(this);}else{j(this,c);}}:function(c){j(this,c);};var e;if(!U&&aq&&ab.features.implementsDomRange){e=function(c){var f=false;if(c.anchorNode){f=m.comparePoints(c.anchorNode,c.anchorOffset,c.focusNode,c.focusOffset)==1;}return f;};G.isBackwards=function(){return e(this);};}else{e=G.isBackwards=function(){return false;};}G.toString=function(){for(var c=[],f=0,g=this.rangeCount;f<g;++f){c[f]=""+this._ranges[f];}return c.join("");};G.collapse=function(c,f){ai(this,c);var g=ab.createRange(m.getDocument(c));g.collapseToPoint(c,f);this.removeAllRanges();this.addRange(g);this.isCollapsed=true;};G.collapseToStart=function(){if(this.rangeCount){var c=this._ranges[0];this.collapse(c.startContainer,c.startOffset);}else{throw new ac("INVALID_STATE_ERR");}};G.collapseToEnd=function(){if(this.rangeCount){var c=this._ranges[this.rangeCount-1];this.collapse(c.endContainer,c.endOffset);}else{throw new ac("INVALID_STATE_ERR");}};G.selectAllChildren=function(c){ai(this,c);var f=ab.createRange(m.getDocument(c));f.selectNodeContents(c);this.removeAllRanges();this.addRange(f);};G.deleteFromDocument=function(){if(ad&&ao&&this.docSelection.type=="Control"){for(var c=this.docSelection.createRange(),f;c.length;){f=c.item(0);c.remove(f);f.parentNode.removeChild(f);}this.refresh();}else{if(this.rangeCount){c=this.getAllRanges();this.removeAllRanges();f=0;for(var g=c.length;f<g;++f){c[f].deleteContents();}this.addRange(c[g-1]);}}};G.getAllRanges=function(){return this._ranges.slice(0);};G.setSingleRange=function(c){this.setRanges([c]);};G.containsNode=function(c,f){for(var i=0,g=this._ranges.length;i<g;++i){if(this._ranges[i].containsNode(c,f)){return true;}}return false;};G.toHtml=function(){var c="";if(this.rangeCount){c=X.getRangeDocument(this._ranges[0]).createElement("div");for(var f=0,g=this._ranges.length;f<g;++f){c.appendChild(this._ranges[f].cloneContents());}c=c.innerHTML;}return c;};G.getName=function(){return"WrappedSelection";};G.inspect=function(){return an(this);};G.detach=function(){this.win=this.anchorNode=this.focusNode=this.win._rangySelection=null;};ar.inspect=an;ab.Selection=ar;ab.selectionPrototype=G;ab.addCreateMissingNativeApiListener(function(c){if(typeof c.getSelection=="undefined"){c.getSelection=function(){return ab.getSelection(this);};}c=null;});});rangy.createModule("Coordinates",function(b,h){b.requireModules(["WrappedSelection","WrappedRange"]);var i="number";var l=b.WrappedRange;var d=b.dom,k=b.util;function f(r){var s=0,t=0;if(typeof r.pageXOffset==i&&typeof r.pageYOffset==i){s=r.pageXOffset;t=r.pageYOffset;}else{var n=r.document;var o=n.documentElement;var m=n.compatMode;var q=(typeof m=="string"&&m.indexOf("CSS")>=0&&o)?o:d.getBody(n);if(q&&typeof q.scrollLeft==i&&typeof q.scrollTop==i){try{s=q.scrollLeft;t=q.scrollTop;}catch(p){}}}return{x:s,y:t};}function e(m,n){n=n.toLowerCase();while(m){if(m.nodeType==1&&m.tagName.toLowerCase()==n){return m;}m=m.parentNode;}return null;}function j(p,o,m,n){this.top=p;this.right=o;this.bottom=m;this.left=n;this.width=o-n;this.height=m-p;}function c(o,m,n){return new j(o.top+n,o.right+m,o.bottom+n,o.left+m);}function a(u,q){var s=0,t=0;var r=q.documentElement,m=d.getBody(q);var p=(r.clientWidth===0&&typeof m.clientTop==i)?m:r;var n=p.clientLeft,o=p.clientTop;if(n){s=-n;}if(o){t=-o;}return c(u,s,t);}function g(r){var t=[],m=[],o=[],s=[];for(var n=0,p=r.length,q;n<p;++n){q=r[n];if(q){t.push(q.top);m.push(q.bottom);o.push(q.left);s.push(q.right);}}return new j(Math.min.apply(Math,t),Math.max.apply(Math,s),Math.max.apply(Math,m),Math.min.apply(Math,o));}(function(){var w=document.createElement("span");var p=k.isHostMethod(w,"getBoundingClientRect");w=null;var v=false,u=false;if(b.features.implementsDomRange){var x=b.createNativeRange();v=k.isHostMethod(x,"getClientRects");u=k.isHostMethod(x,"getBoundingClientRect");x.detach();}k.extend(b.features,{rangeSupportsGetBoundingClientRect:u,rangeSupportsGetClientRects:v,elementSupportsGetBoundingClientRect:p});var m=function(y){return function(){var z=this.cloneRange();z.collapse(y);var A=z.getBoundingClientRect();return{x:A[y?"left":"right"],y:A[y?"top":"bottom"]};};};var t=b.rangePrototype;if(b.features.implementsTextRange&&p){t.getBoundingClientRect=function(){var J=l.rangeToTextRange(this);var z=this.getNodes([1],function(K){return/^t[dh]$/i.test(K.tagName);});var D,E=[];if(z.length>0){var C=e(this.startContainer,"table");for(var B=0,y,I,H,F,G;y=z[B];++B){H=e(y,"table");if(!C||H!=C){F=this.cloneRange();if(C){F.setStartAfter(C);}F.setEndBefore(H);E.push(l.rangeToTextRange(F).getBoundingClientRect());}if(this.containsNode(y)){E.push(y.getBoundingClientRect());}else{I=J.duplicate();I.moveToElementText(y);if(I.compareEndPoints("StartToStart",J)==-1){I.setEndPoint("StartToStart",J);}else{if(I.compareEndPoints("EndToEnd",J)==1){I.setEndPoint("EndToEnd",J);}}E.push(I.getBoundingClientRect());}C=H;}var A=e(this.endContainer,"table");if(!A&&C){F=this.cloneRange();F.setStartAfter(C);E.push(l.rangeToTextRange(F).getBoundingClientRect());}D=g(E);}else{D=J.getBoundingClientRect();}return a(D,d.getDocument(this.startContainer));};}else{if(b.features.implementsDomRange){var o=function(y){return(y instanceof l)?y:new l(y);};if(u){t.getBoundingClientRect=function(){var y=o(this).nativeRange;var z=y.getBoundingClientRect()||y.getClientRects()[0];return a(z,d.getDocument(this.startContainer));};if(v){var r=function(z,A){var y=z.childNodes;};m=function(y){return function(){var B,A=o(this).nativeRange;var C=A.getClientRects();if(C.length==0&&p){if(y){}console.log(A,A.getClientRects(),A.getBoundingClientRect());if(this.collapsed&&this.startContainer.nodeType==1&&this.startOffset<this.startContainer.childNodes.length){var z=this.startContainer.childNodes[this.startOffset];if(z.getClientRects){console.log(z,z.getClientRects(),this.startContainer.getClientRects());}}}if(C.length>0){if(y){B=C[0];return{x:B.left,y:B.top};}else{B=C[C.length-1];return{x:B.right,y:B.bottom};}}else{throw h.createError("Cannot get position for range "+this.inspect());}};};}}else{var q=p?function(y){return a(y.getBoundingClientRect(),d.getDocument(y));}:function(z){var D=0,E=0,B=z,C=z.offsetWidth,A=z.offsetHeight;while(B){D+=B.offsetLeft;E+=B.offsetTop;B=B.offsetParent;}return a(new j(E,D+C,E+A,D),d.getDocument(z));};var s=function(C){var D;C.splitBoundaries();var F=document.createElement("span");if(C.collapsed){C.insertNode(F);D=q(F);F.parentNode.removeChild(F);}else{var H=C.cloneRange();H.collapse(true);H.insertNode(F);var G=q(F);F.parentNode.removeChild(F);H.collapseToPoint(C.endContainer,C.endOffset);H.insertNode(F);var z=q(F);F.parentNode.removeChild(F);var E=[G,z];var y=C.getNodes([1],function(I){return C.containsNode(I);});for(var A=0,B=y.length;A<B;++A){E.push(q(y[A]));}D=g(E);}C.normalizeBoundaries();return D;};t.getBoundingClientRect=function(y){return s(o(y));};}function n(y){return function(){var z=this["get"+(y?"Start":"End")+"ClientPos"]();var A=f(d.getWindow(this.startContainer));return{x:z.x+A.x,y:z.y+A.y};};}}}k.extend(t,{getBoundingDocumentRect:function(){var y=f(d.getWindow(this.startContainer));return c(this.getBoundingClientRect(),y.x,y.y);},getStartClientPos:m(true),getEndClientPos:m(false),getStartDocumentPos:n(true),getEndDocumentPos:n(false)});})();(function(){function m(p,q){return p.compareBoundaryPoints(q.START_TO_START,q);}function o(p){return function(){var r="getBounding"+(p?"Document":"Client")+"Rect";var u=[];for(var q=0,t=null,s;q<this.rangeCount;++q){u.push(this.getRangeAt(q)[r]());}return g(u);};}function n(q,p){return function(){if(this.rangeCount==0){return null;}var r=p?"Document":"Client";var s=this.getAllRanges();if(s.length>1){s.sort(m);}return q?s[0]["getStart"+r+"Pos"]():s[s.length-1]["getEnd"+r+"Pos"]();};}k.extend(b.selectionPrototype,{getBoundingClientRect:o(false),getBoundingDocumentRect:o(true),getStartClientPos:n(true,false),getEndClientPos:n(false,false),getStartDocumentPos:n(true,true),getEndDocumentPos:n(false,true)});})();});